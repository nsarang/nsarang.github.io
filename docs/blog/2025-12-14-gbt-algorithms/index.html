<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Nima Sarang">
<meta name="dcterms.date" content="2025-12-14">
<meta name="description" content="Building a minimal GBT library from scratch to understand what’s actually happening under the hood, and to have the flexibility to experiment with new ideas.">

<title>Implementing Gradient Boosted Trees from Scratch - LightGBM, XGBoost, CatBoost – Nima Sarang</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../_assets/favicon.svg" rel="icon" type="image/svg+xml">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-8616c7f281cfea701ad572e25805fc55.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark-63dafcac75349989ca7e16086db656f4.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-8616c7f281cfea701ad572e25805fc55.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-256e92bf42198d7cb730868569ebd42b.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark-a2a4372a1b20a2ece88021a36a394fcc.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../../site_libs/bootstrap/bootstrap-256e92bf42198d7cb730868569ebd42b.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-HWSGHN8N8N"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-HWSGHN8N8N', { 'anonymize_ip': true});
</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">

<!-- ==== Legacy ==== -->
<link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@300;400;700&amp;display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Petrona:wght@400;500&amp;display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Red+Hat+Text:ital,wght@0,400;0,500;1,400;1,500&amp;display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=B612:ital,wght@0,400;0,700;1,400;1,700&amp;family=B612+Mono:ital,wght@0,400;0,700;1,400;1,700&amp;display=swap" rel="stylesheet">

<!-- ==== Main ==== -->
<link href="https://fonts.googleapis.com/css2?family=PT+Serif:ital,wght@0,400;0,700;1,400;1,700&amp;display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Source+Serif+4:ital,opsz,wght@0,8..60,200..900;1,8..60,200..900&amp;display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&amp;display=swap" rel="stylesheet">
<!-- Source Serif Pro -->
<link href="https://use.typekit.net/sie7yap.css" rel="stylesheet">

<!-- ==== Code ==== -->
<!-- JetBrains Mono -->
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&amp;display=swap" rel="stylesheet">
<!-- Fira Code -->
<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300..700&amp;display=swap" rel="stylesheet">
<!-- Roboto Mono -->
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&amp;display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="style.css">
<meta property="og:title" content="Implementing Gradient Boosted Trees from Scratch - LightGBM, XGBoost, CatBoost">
<meta property="og:description" content="Building a minimal GBT library from scratch to understand what’s actually happening under the hood, and to have the flexibility to experiment with new ideas.">
<meta property="og:image" content="https://www.nimasarang.com/blog/2025-12-14-gbt-algorithms/featured.jpg">
<meta property="og:site_name" content="Nima Sarang">
<meta name="twitter:title" content="Implementing Gradient Boosted Trees from Scratch - LightGBM, XGBoost, CatBoost">
<meta name="twitter:description" content="Building a minimal GBT library from scratch to understand what’s actually happening under the hood, and to have the flexibility to experiment with new ideas.">
<meta name="twitter:image" content="https://www.nimasarang.com/blog/2025-12-14-gbt-algorithms/featured.jpg">
<meta name="twitter:card" content="summary_large_image">
<meta name="citation_title" content="Implementing Gradient Boosted Trees from Scratch - LightGBM, XGBoost, CatBoost">
<meta name="citation_author" content="Nima Sarang">
<meta name="citation_publication_date" content="2025-12-14">
<meta name="citation_cover_date" content="2025-12-14">
<meta name="citation_year" content="2025">
<meta name="citation_online_date" content="2025-12-14">
<meta name="citation_fulltext_html_url" content="https://www.nimasarang.com/blog/2025-12-14-gbt-algorithms/">
<meta name="citation_language" content="en">
</head>

<body class="nav-fixed quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const queryPrefersDark = window.matchMedia('(prefers-color-scheme: dark)');
    const darkModeDefault = queryPrefersDark.matches;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    queryPrefersDark.addEventListener("change", e => {
      if(window.localStorage.getItem("quarto-color-scheme") !== null)
        return;
      const alternate = e.matches
      toggleColorMode(alternate);
      localAlternateSentinel = e.matches ? 'alternate' : 'default'; // this is used alongside local storage!
      toggleGiscusIfUsed(alternate, darkModeDefault);
    });
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../_assets/favicon.svg" alt="" class="navbar-logo light-content">
    <img src="../../_assets/favicon.svg" alt="" class="navbar-logo dark-content">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Nima Sarang</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about/index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../project/index.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../publication/index.html"> 
<span class="menu-text">Publications</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools tools-wide">
    <a href="https://www.github.com/nsarang" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
    <a href="https://www.linkedin.com/in/nima-sarang" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-linkedin"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns">
<div id="title-block-header-title" class="quarto-title page-columns page-full page-layout-full featured-image p-4" style="background-image: url(featured.png), url(featured.jpg), url(../featured.jpg); background-repeat: no-repeat;">
<h1 class="title">Implementing Gradient Boosted Trees from Scratch - LightGBM, XGBoost, CatBoost</h1>
    <div class="quarto-categories">
        <div class="quarto-category">ML</div>
        <div class="quarto-category">Algorithms</div>
        <div class="quarto-category">From Scratch</div>
        <div class="quarto-category">GBT</div>
        <div class="quarto-category">XGBoost</div>
        <div class="quarto-category">LightGBM</div>
        <div class="quarto-category">CatBoost</div>
      </div>
  </div>

<div>
  <div id="title-block-title-desc" class="description pt-4">
    Building a minimal GBT library from scratch to understand what’s actually happening under the hood, and to have the flexibility to experiment with new ideas.
  </div>
</div>


<div class="quarto-title-meta column-body">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Nima Sarang </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">December 14, 2025</p>
    </div>
  </div>
  
    
  </div>
  



</header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="1">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a></li>
  <li><a href="#what-youll-find-here" id="toc-what-youll-find-here" class="nav-link" data-scroll-target="#what-youll-find-here"><span class="header-section-number">2</span> What you’ll find here</a></li>
  <li><a href="#the-math" id="toc-the-math" class="nav-link" data-scroll-target="#the-math"><span class="header-section-number">3</span> The math</a></li>
  <li><a href="#implementation" id="toc-implementation" class="nav-link" data-scroll-target="#implementation"><span class="header-section-number">4</span> Implementation</a>
  <ul class="collapse">
  <li><a href="#gradient-boosted-model-gbm" id="toc-gradient-boosted-model-gbm" class="nav-link" data-scroll-target="#gradient-boosted-model-gbm"><span class="header-section-number">4.1</span> Gradient Boosted Model (GBM)</a></li>
  <li><a href="#data-preprocessing" id="toc-data-preprocessing" class="nav-link" data-scroll-target="#data-preprocessing"><span class="header-section-number">4.2</span> Data Preprocessing</a></li>
  <li><a href="#node-and-tree-structures" id="toc-node-and-tree-structures" class="nav-link" data-scroll-target="#node-and-tree-structures"><span class="header-section-number">4.3</span> Node and Tree Structures</a></li>
  <li><a href="#tree-optimization" id="toc-tree-optimization" class="nav-link" data-scroll-target="#tree-optimization"><span class="header-section-number">4.4</span> Tree Optimization</a></li>
  <li><a href="#loss-functions-and-distributions" id="toc-loss-functions-and-distributions" class="nav-link" data-scroll-target="#loss-functions-and-distributions"><span class="header-section-number">4.5</span> Loss Functions and Distributions</a></li>
  <li><a href="#utility-functions" id="toc-utility-functions" class="nav-link" data-scroll-target="#utility-functions"><span class="header-section-number">4.6</span> Utility Functions</a></li>
  </ul></li>
  <li><a href="#experiments" id="toc-experiments" class="nav-link" data-scroll-target="#experiments"><span class="header-section-number">5</span> Experiments</a>
  <ul class="collapse">
  <li><a href="#census-income-dataset" id="toc-census-income-dataset" class="nav-link" data-scroll-target="#census-income-dataset"><span class="header-section-number">5.1</span> Census Income Dataset</a></li>
  <li><a href="#california-housing-price" id="toc-california-housing-price" class="nav-link" data-scroll-target="#california-housing-price"><span class="header-section-number">5.2</span> California Housing Price</a></li>
  </ul></li>
  <li><a href="#final-thoughts" id="toc-final-thoughts" class="nav-link" data-scroll-target="#final-thoughts"><span class="header-section-number">6</span> Final thoughts</a></li>
  </ul>
<div class="quarto-code-links"><h2>Code Links</h2><ul><li><a href="https://github.com/nsarang/minimal-gbt"><i class="bi bi-file-code"></i>Source Code</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full column-body" id="quarto-document-content">

<style>
  body {
    visibility: hidden; /* initially hidden until DOM ready to prevent flicker */
  }
</style>
<noscript>
  <style>
    body {
      visibility: visible !important; /* Override hidden state when JS is disabled */
    }
  </style>
</noscript>

<!-- source: https://github.com/gadenbuie/garrickadenbuie-com/blob/main/_partials/title-block-link-buttons/title-block.html -->
<!-- 
<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title"> 
-->
<!-- <header id="title-block-header" class="quarto-title-block default page-columns"> -->
<!-- <div class="quarto-title page-columns page-full featured-image p-4" style="background-image: url(featured.png), url(featured.jpg), url(../featured.jpg);"> -->



<div class="hidden">
% Meta %
<p>% Optional argument [#1]: Size modifier (e.g., , ) % #2: Opening delimiter % #3: Closing delimiter % #4: Content</p>
<p>% Common sets % Real numbers % Integers % Natural numbers % Rational numbers % Complex numbers</p>
<p>% Probability and statistics % Expectation % Variance % Covariance % Probability measure % Indicator function</p>
% Linear algebra
% Matrix
<p>% Vector % Trace % Rank % Range (image) % Projection</p>
% Calculus and analysis % For integrals, e.g., f(x) x
% Partial derivative \newcommand{[2]}{ #1} % Partial derivative w/o fraction
<p>% Second partial derivative % Gradient % Divergence % Curl</p>
% Set theory
% Set
<p>% Set builder notation % Union % Intersection % Symmetric difference</p>
<p>% Logic and proofs % Implies % If and only if % End of proof % Contradiction</p>
% Norms and inner products
% Norm
<p>% Inner product</p>
<p>% Common functions % Minimization problem % Maximization problem % Argument minimum % Argument maximum</p>
<p>% Subject to constraints % Sign function % Span of a set</p>
% Formatting
% Absolute value
% Parentheses
% Brackets
% Floor function
<p>% Ceiling function</p>
<p>% Asymptotic notations % Big O notation % Small o notation % Big Omega notation % Big Theta notation</p>
<p>% Commonly used in algorithms and complexity % Polynomial time % Polylogarithmic time</p>
<p>% Additional probability notations % Independent and identically distributed % Distributed as</p>
<p>% Fourier transform % Fourier transform % Inverse Fourier transform</p>
<p>% General math % Display style</p>
</div>
<style>
</style>
<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>In my line of work, Gradient Boosted Trees (GBTs) algorithms such as LightGBM, XGBoost, and CatBoost are the go-to models for tabular data. Not only are they great for fast prototyping, but they also deliver a strong baseline performance that is hard to beat. Having said that, these libraries are complex pieces of software that don’t offer the flexibility to customize and apply research ideas. I often found myself spending hours going through thousands of lines of source code, only to be more confused at the end. Granted, the maintainers have a high incentive to optimize for accuracy and speed, not so much for code readability and extensibility.</p>
<p>That’s why I decided to implement my own GBT library from scratch, with a balance between simplicity and functionality. I’ve gone through the original papers, and made a decision to implement the components that I find most essential. There’s always room for improvement but I didn’t want to make it too complex, as that would reduce its educational value.</p>
<div class="callout callout-style-default callout-note callout-titled" title="Note">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<p>This is the second post in my “From Scratch” series. The first covered implementing LSTMs using only NumPy <a href="../../blog/2024-06-15-lstm-from-scratch/index.html">here</a>.</p>
</div>
</div>
</div>
</section>
<section id="what-youll-find-here" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> What you’ll find here</h1>
<p>In this post I’ll walk through the implementation of each component one by one. The following features have been implemented:</p>
<ol type="1">
<li><strong>Histogram-based</strong> splitting [LightGBM/XGBoost style]</li>
<li><strong>Multi-output</strong> decision trees
<ul>
<li>Supports multivariate regression, multi-class classification, and uncertainty estimation</li>
</ul></li>
<li><strong>Leaf-wise</strong> binary tree growth [LightGBM]</li>
<li><strong>Categorical feature handling</strong>
<ul>
<li>via ordered target statistics [CatBoost]</li>
<li>via gradient-based ordering, i.e.&nbsp;Fisher’s statistics [LightGBM]</li>
</ul></li>
<li>L1 and L2 <strong>regularization</strong></li>
<li>Gradient-based One-Side Sampling (<strong>GOSS</strong>) [LightGBM]</li>
<li>Data subsampling</li>
<li><strong>Automatic handling of missing values</strong>. Use <code>np.nan</code> to designate missing values [XGBoost]
<ul>
<li>Evaluate gain for directing nulls to left vs right child at each split</li>
</ul></li>
<li><strong>Path smoothing</strong> with exponential-decaying weights
<ul>
<li>Regularize leaf predictions by blending with ancestor values along the path</li>
</ul></li>
</ol>
<p>One thing I found interesting is how much these libraries have evolved since their original publications, and how much they borrow ideas from each other. For example, if you were to use LightGBM and XGBoost using their default parameters, you’d find they’re functionally very similar.</p>
</section>
<section id="the-math" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> The math</h1>
<p>This is a refresher for the math behind GBTs, which I’ll try to keep brief. The main idea is to sequentially add decision trees to an ensemble, where the objective is to minimize the difference between the true labels and the output of the existing ensemble using gradient descent:</p>
<p><span id="eq-gbt-loss"><span class="math display">\[
\min_{F} \sum_{(x, y) \in \mathcal{D}} \mathcal{L}\left(y, F(x)\right)
\tag{1}\]</span></span></p>
<p>where <span class="math inline">\(\displaystyle F_m(x) = \sum_{i=0}^{m} T_i(x)\)</span> is an additive ensemble of trees. Since we’re optimizing over functions (trees) rather than parameters, this approach is termed <strong>functional gradient descent</strong>.</p>
<p>At iteration <span class="math inline">\(k\)</span>, given current predictions <span class="math inline">\(F_{k-1}(x)\)</span>, we fit a new tree <span class="math inline">\(T_k(x)\)</span> that moves us in the direction of reducing <span class="math inline">\(\mathcal{L}\)</span>. Using a second-order Taylor approximation (Newton-Raphson), for a sample <span class="math inline">\((x_i, y_i)\)</span> we have:</p>
<p><span id="eq-taylor"><span class="math display">\[
J = \mathcal{L}(y_i, F_{k-1}(x_i) + T_k(x_i)) \approx \mathcal{L}(y_i, F_{k-1}(x_i)) + g_i T_k(x_i) + \frac{1}{2} h_i T_k^2(x_i)
\tag{2}\]</span></span></p>
<p>where <span class="math inline">\(g_i = \frac{\partial \mathcal{L}}{\partial F}\)</span> (gradient) and <span class="math inline">\(h_i = \frac{\partial^2 \mathcal{L}}{\partial F^2}\)</span> (Hessian). Since the first term is constant with respect to <span class="math inline">\(T_k\)</span>, we only need to minimize <span class="math inline">\(g_i T_k(x_i) + \frac{1}{2} h_i T_k^2(x_i)\)</span>. For samples in a leaf node <span class="math inline">\(S\)</span>, the optimal output value <span class="math inline">\(v = T_k(x_i) \quad\forall x_i \in S\)</span> is found by setting the derivative of <a href="#eq-taylor" class="quarto-xref">Eq.&nbsp;2</a> to zero:</p>
<p><span id="eq-optimal-leaf"><span class="math display">\[
\displaystyle\frac{\partial}{\partial v} \sum_{i \in S} \left(g_i v + \frac{1}{2} h_i v^2\right) = 0 \implies v = -\frac{\sum_{i \in S} g_i}{\sum_{i \in S} h_i}
\tag{3}\]</span></span></p>
<p>We can also add an L2 regularization term <span class="math inline">\(\frac{1}{2} \lambda v^2\)</span> to penalize large magnitude values, with <span class="math inline">\(\lambda\)</span> being the strength hyperparameter. The loss function becomes:</p>
<p><span id="eq-loss-with-reg"><span class="math display">\[
J_S = \sum_{i \in S} \left(g_i v + \frac{1}{2} h_i v^2\right) + \frac{1}{2} \lambda v^2
\tag{4}\]</span></span></p>
<p>and consequently, the optimal leaf value becomes:</p>
<p><span id="eq-optimal-leaf-reg"><span class="math display">\[
v = -\frac{\sum_{i \in S} g_i}{\sum_{i \in S} h_i + \lambda}
\tag{5}\]</span></span></p>
<p>Note that this is even before we considered how to split the tree nodes, but <a href="#eq-optimal-leaf-reg" class="quarto-xref">Eq.&nbsp;5</a> stands on its own for a fixed tree structure. We can use the leaf value to compute the contribution of a node to the overall loss <em>reduction</em>, by substituting <span class="math inline">\(v\)</span> from <a href="#eq-optimal-leaf-reg" class="quarto-xref">Eq.&nbsp;5</a> into <a href="#eq-loss-with-reg" class="quarto-xref">Eq.&nbsp;4</a>, and negating it:</p>
<p><span class="math display">\[
\text{Gain}(S) = \frac{1}{2} \frac{(\sum_{i \in S} g_i)^2}{\sum_{i \in S} h_i + \lambda}
\]</span></p>
<p><span class="math inline">\(Gain(S)\)</span> represents how much the loss would <em>decrease</em> if we created a node covering subset <span class="math inline">\(S\)</span> of samples in the dataset. Using this, we can evaluate the contribution of a node split by adding the contributions of its two child nodes and subtracting the parent node’s contribution, since the parent node will no longer be a leaf after the split. Assuming <span class="math inline">\(L \subseteq S\)</span> and <span class="math inline">\(R = S \setminus L\)</span> are the left and right child nodes after the split, the gain from the split is:</p>
<p><span id="eq-split-gain"><span class="math display">\[
\text{SplitGain}(S, L, R) = \text{Gain}(L) + \text{Gain}(R) - \text{Gain}(S)
\tag{6}\]</span></span></p>
<p>SplitGain is what we maximize during tree construction, and <span class="math inline">\(&gt;0\)</span> is the minimum threshold for a split to be considered beneficial. At each node, we evaluate all features and all possible split thresholds, and select the split with the highest gain. Then, among all node candidates to split, we select the one with the highest SplitGain to actually perform the split. This is called <strong>leaf-wise growth</strong>.</p>
<p>To extend this to multi-output settings, we could either build separate trees for each output, or, what I implemented here is to treat <span class="math inline">\(T(x)\)</span>, <span class="math inline">\(v\)</span>, <span class="math inline">\(g_i\)</span>, and <span class="math inline">\(h_i\)</span> as vectors. The derivations remain mostly the same, except that we now sum over the per-output gain to get the overall gain.</p>
</section>
<section id="implementation" class="level1 page-columns page-full" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Implementation</h1>
<p>The source code is organized into the following modules, which I’ll go through one by one in order:</p>
<ol type="1">
<li><a href="#gradient-boosted-model-gbm">Gradient Boosted Model (GBM)</a>: The model class that ties everything together.</li>
<li><a href="#data-preprocessing">Data Preprocessing</a>: Preprocessing categorical and numerical features, and preparing data for training and inference.</li>
<li><a href="#node-and-tree-structures">Node and Tree Structures</a>: Data structures for decision tree and its nodes.</li>
<li><a href="#tree-optimization">Tree Optimization</a>: The core logic for fitting decision trees using histogram-based splitting and leaf-wise growth.</li>
<li><a href="#loss-functions-and-distributions">Loss Functions and Distributions</a>: Implementing loss functions.</li>
<li><a href="#utility-functions">Utility Functions</a>: A few utility functions used throughout the code.</li>
</ol>
<!--------- GBM ----------->
<section id="gradient-boosted-model-gbm" class="level2 page-columns page-full" data-number="4.1">
<h2 data-number="4.1" data-anchor-id="gradient-boosted-model-gbm"><span class="header-section-number">4.1</span> Gradient Boosted Model (GBM)</h2>
<p>This is the main class that ties everything together. It initializes the distribution, data handler, and manages the training process. I think it’s helpful to have a high-level view first before diving into the implementation of each component. The API deliberately mirrors the fit/predict pattern from scikit-learn and familiar GBT libraries but the internals are simple enough to experiment with.</p>
<div id="0456b1cf" class="cell no-style-output page-columns page-full" data-execution_count="2">
<div class="cell-output cell-output-display column-page">
<h3 style="margin-top: 0;">gbm.py</h3>
        <div class="docfuse ">
            
        <div class="section" id="gbm-0">
            <div class="docs">
                <div class="section-link">
                    <a href="#gbm-0">#</a>
                </div>
                <p><strong>Required imports</strong></p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">1</span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="linenos">2</span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="linenos">3</span><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm.auto</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="gbm-1">
            <div class="docs">
                <div class="section-link">
                    <a href="#gbm-1">#</a>
                </div>
                <p>DataPreprocessor handles feature encoding and binning and train/test transformations</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">4</span><span class="kn">from</span><span class="w"> </span><span class="nn">.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataPreprocessor</span>
<span class="linenos">5</span><span class="kn">from</span><span class="w"> </span><span class="nn">.distributions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Distribution</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="gbm-2">
            <div class="docs">
                <div class="section-link">
                    <a href="#gbm-2">#</a>
                </div>
                <p>TreeGrower handles the logic of growing individual trees</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">6</span><span class="kn">from</span><span class="w"> </span><span class="nn">.grower</span><span class="w"> </span><span class="kn">import</span> <span class="n">TreeGrower</span>
<span class="linenos">7</span><span class="kn">from</span><span class="w"> </span><span class="nn">.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">trunc</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="gbm-3">
            <div class="docs">
                <div class="section-link">
                    <a href="#gbm-3">#</a>
                </div>
                <h3>Gradient Boosted Model (GBM)</h3>
<p>This is the user-facing class for training and making predictions.</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>distribution</code> : Distribution
<ul>
<li>The loss distribution to optimize.</li>
</ul>
</li>
<li><code>learning_rate</code> : float, default=0.1
<ul>
<li>The learning rate (shrinkage factor) for each tree's contribution.</li>
</ul>
</li>
<li><code>n_trees</code> : int, default=100
<ul>
<li>The number of trees to grow in the ensemble.</li>
</ul>
</li>
<li><code>n_leaves</code> : int, default=20
<ul>
<li>The maximum number of leaves per tree.</li>
</ul>
</li>
<li><code>max_depth</code> : int, default=6
<ul>
<li>The maximum depth of each tree.</li>
</ul>
</li>
<li><code>min_samples_split</code> : int, default=2
<ul>
<li>The minimum number of samples required to split a node.</li>
</ul>
</li>
<li><code>min_weight_leaf</code> : float, default=20
<ul>
<li>The minimum sum of instance weights required in a leaf node for a split to be considered.</li>
</ul>
</li>
<li><code>min_gain_to_split</code> : float, default=0.0
<ul>
<li>The minimum gain required to perform a split. Referred to as \(\gamma\) in some literature.</li>
</ul>
</li>
<li><code>objective_weight</code> : List[float], optional
<ul>
<li>Weights for multi-output objectives. If the distribution is multivariate,
this specifies the relative importance of each output dimension.</li>
</ul>
</li>
<li><code>l1_regularization</code> : float, default=0.0
<ul>
<li>L1 regularization term on leaf values.</li>
</ul>
</li>
<li><code>l2_regularization</code> : float, default=0.0
<ul>
<li>L2 regularization term on leaf values.</li>
</ul>
</li>
<li><code>feature_fraction</code> : float, default=1.0
<ul>
<li>The fraction of features to subsample for each tree (Values between 0 and 1). This helps with regularization.</li>
</ul>
</li>
<li><code>samples_fraction</code> : float, default=1.0
<ul>
<li>The fraction of training samples to subsample for each tree. Values between 0 and 1.</li>
</ul>
</li>
<li><code>goss_top_rate</code> : float, optional
<ul>
<li>Whether to use GOSS sampling. If set, specifies the top fraction of samples (by absolute gradient) to keep.</li>
</ul>
</li>
<li><code>goss_bottom_rate</code> : float, optional
<ul>
<li>If using GOSS, specifies the bottom fraction of samples (by absolute gradient) to keep.</li>
</ul>
</li>
<li><code>goss_rescale_bottom</code> : bool, optional
<ul>
<li>Whether to rescale the weights of the bottom samples in GOSS to maintain the overall weight sum.</li>
</ul>
</li>
<li><code>path_smoothing_strength</code> : float, default=0.0
<ul>
<li>Strength of path smoothing to apply to leaf values after tree is grown.</li>
</ul>
</li>
<li><code>max_bins</code> : int, default=255
<ul>
<li>The maximum number of bins to use for numerical features.</li>
</ul>
</li>
<li><code>max_categories</code> : int, default=100
<ul>
<li>The maximum number of unique categories for a feature to be treated as categorical. Otherwise, it is encoded as numerical using label encoding.</li>
</ul>
</li>
<li><code>n_permutations</code> : int, default=10
<ul>
<li>Number of random permutations to use for ordered target statistics encoding of categorical features (CatBoost-style).</li>
</ul>
</li>
<li><code>prior_strength</code> : float, default=1.0
<ul>
<li>The strength of the prior for target statistics encoding.</li>
</ul>
</li>
<li><code>seed</code> : int, optional
<ul>
<li>Random seed for reproducibility.</li>
</ul>
</li>
<li><code>verbose</code> : bool, default=True
<ul>
<li>Whether to print progress messages during training.</li>
</ul>
</li>
</ul>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos"> 8</span><span class="k">class</span><span class="w"> </span><span class="nc">GradientBoostedModel</span><span class="p">:</span>
<span class="linenos"> 9</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<span class="linenos">10</span>        <span class="bp">self</span><span class="p">,</span>
<span class="linenos">11</span>        <span class="n">distribution</span><span class="p">:</span> <span class="n">Distribution</span><span class="p">,</span>
<span class="linenos">12</span>        <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
<span class="linenos">13</span>        <span class="n">n_trees</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
<span class="linenos">14</span>        <span class="n">n_leaves</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
<span class="linenos">15</span>        <span class="n">max_depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
<span class="linenos">16</span>        <span class="n">min_samples_split</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="linenos">17</span>        <span class="n">min_weight_leaf</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
<span class="linenos">18</span>        <span class="n">min_gain_to_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
<span class="linenos">19</span>        <span class="n">objective_weight</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">20</span>        <span class="n">l1_regularization</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
<span class="linenos">21</span>        <span class="n">l2_regularization</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
<span class="linenos">22</span>        <span class="n">feature_fraction</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
<span class="linenos">23</span>        <span class="n">samples_fraction</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
<span class="linenos">24</span>        <span class="n">goss_top_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">25</span>        <span class="n">goss_bottom_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">26</span>        <span class="n">goss_rescale_bottom</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="linenos">27</span>        <span class="n">path_smoothing_strength</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
<span class="linenos">28</span>        <span class="n">max_bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">255</span><span class="p">,</span>
<span class="linenos">29</span>        <span class="n">max_categories</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
<span class="linenos">30</span>        <span class="n">n_permutations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
<span class="linenos">31</span>        <span class="n">prior_strength</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
<span class="linenos">32</span>        <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">33</span>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="linenos">34</span>    <span class="p">):</span>
<span class="linenos">35</span>        <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="o">=</span> <span class="n">distribution</span>
<span class="linenos">36</span>        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="n">learning_rate</span>
<span class="linenos">37</span>        <span class="bp">self</span><span class="o">.</span><span class="n">n_trees</span> <span class="o">=</span> <span class="n">n_trees</span>
<span class="linenos">38</span>        <span class="bp">self</span><span class="o">.</span><span class="n">n_leaves</span> <span class="o">=</span> <span class="n">n_leaves</span>
<span class="linenos">39</span>        <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span> <span class="o">=</span> <span class="n">max_depth</span>
<span class="linenos">40</span>        <span class="bp">self</span><span class="o">.</span><span class="n">min_samples_split</span> <span class="o">=</span> <span class="n">min_samples_split</span>
<span class="linenos">41</span>        <span class="bp">self</span><span class="o">.</span><span class="n">min_weight_leaf</span> <span class="o">=</span> <span class="n">min_weight_leaf</span>
<span class="linenos">42</span>        <span class="bp">self</span><span class="o">.</span><span class="n">min_gain_to_split</span> <span class="o">=</span> <span class="n">min_gain_to_split</span>
<span class="linenos">43</span>        <span class="bp">self</span><span class="o">.</span><span class="n">objective_weight</span> <span class="o">=</span> <span class="n">objective_weight</span>
<span class="linenos">44</span>        <span class="bp">self</span><span class="o">.</span><span class="n">l1_regularization</span> <span class="o">=</span> <span class="n">l1_regularization</span>
<span class="linenos">45</span>        <span class="bp">self</span><span class="o">.</span><span class="n">l2_regularization</span> <span class="o">=</span> <span class="n">l2_regularization</span>
<span class="linenos">46</span>        <span class="bp">self</span><span class="o">.</span><span class="n">feature_fraction</span> <span class="o">=</span> <span class="n">feature_fraction</span>
<span class="linenos">47</span>        <span class="bp">self</span><span class="o">.</span><span class="n">samples_fraction</span> <span class="o">=</span> <span class="n">samples_fraction</span>
<span class="linenos">48</span>        <span class="bp">self</span><span class="o">.</span><span class="n">goss_top_rate</span> <span class="o">=</span> <span class="n">goss_top_rate</span>
<span class="linenos">49</span>        <span class="bp">self</span><span class="o">.</span><span class="n">goss_bottom_rate</span> <span class="o">=</span> <span class="n">goss_bottom_rate</span>
<span class="linenos">50</span>        <span class="bp">self</span><span class="o">.</span><span class="n">goss_rescale_bottom</span> <span class="o">=</span> <span class="n">goss_rescale_bottom</span>
<span class="linenos">51</span>        <span class="bp">self</span><span class="o">.</span><span class="n">path_smoothing_strength</span> <span class="o">=</span> <span class="n">path_smoothing_strength</span>
<span class="linenos">52</span>        <span class="bp">self</span><span class="o">.</span><span class="n">max_bins</span> <span class="o">=</span> <span class="n">max_bins</span>
<span class="linenos">53</span>        <span class="bp">self</span><span class="o">.</span><span class="n">max_categories</span> <span class="o">=</span> <span class="n">max_categories</span>
<span class="linenos">54</span>        <span class="bp">self</span><span class="o">.</span><span class="n">n_permutations</span> <span class="o">=</span> <span class="n">n_permutations</span>
<span class="linenos">55</span>        <span class="bp">self</span><span class="o">.</span><span class="n">prior_strength</span> <span class="o">=</span> <span class="n">prior_strength</span>
<span class="linenos">56</span>        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
<span class="linenos">57</span>        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="gbm-4">
            <div class="docs">
                <div class="section-link">
                    <a href="#gbm-4">#</a>
                </div>
                <p>Attributes to be set during fitting</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">58</span>        <span class="bp">self</span><span class="o">.</span><span class="n">data_processor_</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">59</span>        <span class="bp">self</span><span class="o">.</span><span class="n">initial_params_</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">60</span>        <span class="bp">self</span><span class="o">.</span><span class="n">trees_</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">61</span>        <span class="bp">self</span><span class="o">.</span><span class="n">is_fitted_</span> <span class="o">=</span> <span class="kc">False</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="gbm-5">
            <div class="docs">
                <div class="section-link">
                    <a href="#gbm-5">#</a>
                </div>
                <p>Fit the Gradient Boosted Model to the data. This method should give you a high-level
overview of the training process.</p>
<ul>
<li><code>X</code> : pd.DataFrame
<ul>
<li>The input features.</li>
</ul>
</li>
<li><code>y</code> : np.ndarray
<ul>
<li>The target values.</li>
</ul>
</li>
<li><code>sample_weight</code> : np.ndarray, optional
<ul>
<li>Sample weights for each instance.</li>
</ul>
</li>
</ul>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">62</span>    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span> <span class="n">sample_weight</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos">63</span>        <span class="k">if</span> <span class="n">sample_weight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">64</span>            <span class="n">sample_weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">))</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="gbm-6">
            <div class="docs">
                <div class="section-link">
                    <a href="#gbm-6">#</a>
                </div>
                <p>Preprocess data and compute feature info</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">65</span>        <span class="bp">self</span><span class="o">.</span><span class="n">data_processor_</span> <span class="o">=</span> <span class="n">DataPreprocessor</span><span class="p">(</span>
<span class="linenos">66</span>            <span class="n">max_categories</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_categories</span><span class="p">,</span>
<span class="linenos">67</span>            <span class="n">max_bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_bins</span><span class="p">,</span>
<span class="linenos">68</span>            <span class="n">n_permutations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_permutations</span><span class="p">,</span>
<span class="linenos">69</span>            <span class="n">prior_strength</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prior_strength</span><span class="p">,</span>
<span class="linenos">70</span>            <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
<span class="linenos">71</span>        <span class="p">)</span>
<span class="linenos">72</span>        <span class="bp">self</span><span class="o">.</span><span class="n">data_processor_</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sample_weight</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="gbm-7">
            <div class="docs">
                <div class="section-link">
                    <a href="#gbm-7">#</a>
                </div>
                <p>Transform input data into numerical array</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">73</span>        <span class="n">inputs</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_processor_</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
<span class="linenos">74</span>            <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sample_weight</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">"train"</span>
<span class="linenos">75</span>        <span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="gbm-8">
            <div class="docs">
                <div class="section-link">
                    <a href="#gbm-8">#</a>
                </div>
                <p>Initialize tree grower. This handles the logic of growing individual trees.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">76</span>        <span class="n">grower</span> <span class="o">=</span> <span class="n">TreeGrower</span><span class="p">(</span>
<span class="linenos">77</span>            <span class="n">distribution</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">distribution</span><span class="p">,</span>
<span class="linenos">78</span>            <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
<span class="linenos">79</span>            <span class="n">objective_weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">objective_weight</span><span class="p">,</span>
<span class="linenos">80</span>            <span class="n">l1_regularization</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">l1_regularization</span><span class="p">,</span>
<span class="linenos">81</span>            <span class="n">l2_regularization</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">l2_regularization</span><span class="p">,</span>
<span class="linenos">82</span>            <span class="n">min_weight_leaf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_weight_leaf</span><span class="p">,</span>
<span class="linenos">83</span>            <span class="n">max_leaves</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_leaves</span><span class="p">,</span>
<span class="linenos">84</span>            <span class="n">max_depth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span><span class="p">,</span>
<span class="linenos">85</span>            <span class="n">goss_top_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">goss_top_rate</span><span class="p">,</span>
<span class="linenos">86</span>            <span class="n">goss_bottom_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">goss_bottom_rate</span><span class="p">,</span>
<span class="linenos">87</span>            <span class="n">goss_rescale_bottom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">goss_rescale_bottom</span><span class="p">,</span>
<span class="linenos">88</span>            <span class="n">feature_fraction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_fraction</span><span class="p">,</span>
<span class="linenos">89</span>            <span class="n">samples_fraction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">samples_fraction</span><span class="p">,</span>
<span class="linenos">90</span>            <span class="n">min_samples_split</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_samples_split</span><span class="p">,</span>
<span class="linenos">91</span>            <span class="n">min_gain_to_split</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_gain_to_split</span><span class="p">,</span>
<span class="linenos">92</span>            <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
<span class="linenos">93</span>        <span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="gbm-9">
            <div class="docs">
                <div class="section-link">
                    <a href="#gbm-9">#</a>
                </div>
                <p>Initialize the ensemble. Query the Distribution object for initial parameters.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">94</span>        <span class="bp">self</span><span class="o">.</span><span class="n">initial_params_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">init_params</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="linenos">95</span>        <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_params_</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_params_</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="gbm-10">
            <div class="docs">
                <div class="section-link">
                    <a href="#gbm-10">#</a>
                </div>
                <p>Print initial loss</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">96</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
<span class="linenos">97</span>            <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">predictions</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="linenos">98</span>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Initial loss: </span><span class="si">{</span><span class="n">trunc</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="gbm-11">
            <div class="docs">
                <div class="section-link">
                    <a href="#gbm-11">#</a>
                </div>
                <p>Grow trees one by one</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos"> 99</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_trees</span><span class="p">)):</span>
<span class="linenos">100</span>            <span class="n">tree</span> <span class="o">=</span> <span class="n">grower</span><span class="o">.</span><span class="n">grow</span><span class="p">(</span>
<span class="linenos">101</span>                <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span>
<span class="linenos">102</span>                <span class="n">features_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_processor_</span><span class="o">.</span><span class="n">features_info_</span><span class="p">,</span>
<span class="linenos">103</span>                <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span>
<span class="linenos">104</span>                <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">,</span>
<span class="linenos">105</span>                <span class="n">current_predictions</span><span class="o">=</span><span class="n">predictions</span><span class="p">,</span>
<span class="linenos">106</span>            <span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="gbm-12">
            <div class="docs">
                <div class="section-link">
                    <a href="#gbm-12">#</a>
                </div>
                <p>If no valid tree could be grown, stop early.
Could happen due to insufficient data or no tangible gain.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">107</span>            <span class="k">if</span> <span class="n">tree</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">108</span>                <span class="k">break</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="gbm-13">
            <div class="docs">
                <div class="section-link">
                    <a href="#gbm-13">#</a>
                </div>
                <p>Apply path smoothing if specified</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">109</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_smoothing_strength</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
<span class="linenos">110</span>                <span class="n">tree</span><span class="o">.</span><span class="n">apply_smoothing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_smoothing_strength</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="gbm-14">
            <div class="docs">
                <div class="section-link">
                    <a href="#gbm-14">#</a>
                </div>
                <p>Append the new tree and update predictions</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">111</span>            <span class="bp">self</span><span class="o">.</span><span class="n">trees_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
<span class="linenos">112</span>            <span class="n">predictions</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">*</span> <span class="n">tree</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
<span class="linenos">113</span>
<span class="linenos">114</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
<span class="linenos">115</span>                <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">predictions</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="linenos">116</span>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Loss after tree </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">trunc</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="gbm-15">
            <div class="docs">
                <div class="section-link">
                    <a href="#gbm-15">#</a>
                </div>
                
            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">117</span>        <span class="bp">self</span><span class="o">.</span><span class="n">is_fitted_</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">118</span>        <span class="k">return</span> <span class="bp">self</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="gbm-16">
            <div class="docs">
                <div class="section-link">
                    <a href="#gbm-16">#</a>
                </div>
                <p>Make inferences using the fitted model.</p>
<ul>
<li><code>X</code> : pd.DataFrame
<ul>
<li>The input features.</li>
</ul>
</li>
<li>return_type : str or None, default="predict"
<ul>
<li>Transformation to apply to raw predictions. Options depend on the distribution.
It basically passes the raw predictions to the distribution's corresponding method.
If None, returns raw predictions.</li>
</ul>
</li>
</ul>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">119</span>    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">return_type</span><span class="o">=</span><span class="s2">"predict"</span><span class="p">):</span>
<span class="linenos">120</span>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fitted_</span><span class="p">:</span>
<span class="linenos">121</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Model not fitted. Call fit() first."</span><span class="p">)</span>
<span class="linenos">122</span>
<span class="linenos">123</span>        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_processor_</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="gbm-17">
            <div class="docs">
                <div class="section-link">
                    <a href="#gbm-17">#</a>
                </div>
                <p>Start with the initial parameters and add contributions from each tree</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">124</span>        <span class="n">raw_prediction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
<span class="linenos">125</span>            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_params_</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_params_</span>
<span class="linenos">126</span>        <span class="p">)</span>
<span class="linenos">127</span>        <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees_</span><span class="p">:</span>
<span class="linenos">128</span>            <span class="n">raw_prediction</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">*</span> <span class="n">tree</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="gbm-18">
            <div class="docs">
                <div class="section-link">
                    <a href="#gbm-18">#</a>
                </div>
                <p>Return the desired output type. Calls the corresponding implementation in the Distribution class.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">129</span>        <span class="k">if</span> <span class="n">return_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">130</span>            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">distribution</span><span class="p">,</span> <span class="n">return_type</span><span class="p">)(</span><span class="n">raw_prediction</span><span class="p">)</span>
<span class="linenos">131</span>        <span class="k">return</span> <span class="n">raw_prediction</span></pre></div>

            </div>
        </div>
    
        </div>
    
</div>
</div>
</section>
<section id="data-preprocessing" class="level2 page-columns page-full" data-number="4.2">
<h2 data-number="4.2" data-anchor-id="data-preprocessing"><span class="header-section-number">4.2</span> Data Preprocessing</h2>
<p>This module handles categorical feature encoding and numerical feature binning. The transformations are used both during training and inference time.</p>
<div id="7fb1e881" class="cell no-style-output page-columns page-full" data-execution_count="3">
<div class="cell-output cell-output-display column-page">
<h3 style="margin-top: 0;">data.py</h3>
        <div class="docfuse ">
            
        <div class="section" id="data-0">
            <div class="docs">
                <div class="section-link">
                    <a href="#data-0">#</a>
                </div>
                <p>Data preprocessing utilities module. Defines classes and functions for handling
feature information and preprocessing datasets.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">1</span><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="linenos">4</span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="linenos">5</span>
<span class="linenos">6</span><span class="kn">from</span><span class="w"> </span><span class="nn">.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">map_array</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="data-1">
            <div class="docs">
                <div class="section-link">
                    <a href="#data-1">#</a>
                </div>
                <h3>FeatureInfo</h3>
<p>A class to store information about a feature in the dataset.</p>
<p><strong>Attributes</strong></p>
<ul>
<li><code>name</code> : str
<ul>
<li>The name of the feature/column.</li>
</ul>
</li>
<li><code>index</code> : int
<ul>
<li>The position of the feature in the input array.</li>
</ul>
</li>
<li><code>type</code> : str, optional
<ul>
<li>The type of the feature: <code>numerical</code>, <code>categorical</code>, or <code>category_as_numeric</code>.</li>
</ul>
</li>
<li><code>bins</code> : np.ndarray, optional
<ul>
<li>The bin edges for numerical features or categorical features treated as
numeric.</li>
</ul>
</li>
<li><code>categories</code> : np.ndarray, optional
<ul>
<li>The unique categories for categorical features.</li>
</ul>
</li>
<li><code>target_statistics</code> : dict, optional
<ul>
<li>A mapping from category to its target statistic for categorical features
encoded as numeric.</li>
</ul>
</li>
</ul>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos"> 7</span><span class="nd">@dataclass</span>
<span class="linenos"> 8</span><span class="k">class</span><span class="w"> </span><span class="nc">FeatureInfo</span><span class="p">:</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<span class="linenos">11</span>    <span class="n">index</span><span class="p">:</span> <span class="nb">int</span>
<span class="linenos">12</span>    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">13</span>    <span class="n">bins</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">14</span>    <span class="n">categories</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">15</span>    <span class="n">target_statistics</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="data-2">
            <div class="docs">
                <div class="section-link">
                    <a href="#data-2">#</a>
                </div>
                <h3>DataPreprocessor</h3>
<p>A data preprocessor for handling numerical and categorical features. It's used
during both training and prediction.</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>max_categories</code> : int, default=100
<ul>
<li>Maximum number of unique categories for a feature to be treated as
categorical. Otherwise, it is encoded as numerical using label encoding.</li>
</ul>
</li>
<li><code>max_bins</code> : int, default=255
<ul>
<li>Number of bins to use for numerical features and categorical features
treated as numeric.</li>
</ul>
</li>
<li><code>n_permutations</code> : int, default=10
<ul>
<li>Number of random permutations to use for ordered target statistics
encoding of categorical features.</li>
</ul>
</li>
<li><code>seed</code> : int, optional
<ul>
<li>Random seed for reproducibility.</li>
</ul>
</li>
</ul>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">16</span><span class="k">class</span><span class="w"> </span><span class="nc">DataPreprocessor</span><span class="p">:</span>
<span class="linenos">17</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<span class="linenos">18</span>        <span class="bp">self</span><span class="p">,</span>
<span class="linenos">19</span>        <span class="n">max_categories</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
<span class="linenos">20</span>        <span class="n">max_bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">255</span><span class="p">,</span>
<span class="linenos">21</span>        <span class="n">n_permutations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
<span class="linenos">22</span>        <span class="n">prior_strength</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
<span class="linenos">23</span>        <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">24</span>    <span class="p">):</span>
<span class="linenos">25</span>        <span class="bp">self</span><span class="o">.</span><span class="n">max_categories</span> <span class="o">=</span> <span class="n">max_categories</span>
<span class="linenos">26</span>        <span class="bp">self</span><span class="o">.</span><span class="n">max_bins</span> <span class="o">=</span> <span class="n">max_bins</span>
<span class="linenos">27</span>        <span class="bp">self</span><span class="o">.</span><span class="n">n_permutations</span> <span class="o">=</span> <span class="n">n_permutations</span>
<span class="linenos">28</span>        <span class="bp">self</span><span class="o">.</span><span class="n">prior_strength</span> <span class="o">=</span> <span class="n">prior_strength</span>
<span class="linenos">29</span>        <span class="bp">self</span><span class="o">.</span><span class="n">random</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="data-3">
            <div class="docs">
                <div class="section-link">
                    <a href="#data-3">#</a>
                </div>
                <p>A list of FeatureInfo objects, one for each feature in the dataset. To be populated
during the <code>fit</code> method.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">30</span>        <span class="bp">self</span><span class="o">.</span><span class="n">features_info_</span> <span class="o">=</span> <span class="kc">None</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="data-4">
            <div class="docs">
                <div class="section-link">
                    <a href="#data-4">#</a>
                </div>
                <p>Create histograms of features in the dataset. Categorical and numerical
features are handled differently.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">31</span>    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span>
<span class="linenos">32</span>        <span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sample_weight</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">33</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"DataPreprocessor"</span><span class="p">:</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="data-5">
            <div class="docs">
                <div class="section-link">
                    <a href="#data-5">#</a>
                </div>
                <p>Create feature info for each column</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">34</span>        <span class="n">features_info</span> <span class="o">=</span> <span class="p">[]</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="data-6">
            <div class="docs">
                <div class="section-link">
                    <a href="#data-6">#</a>
                </div>
                <p>Identify categorical features</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">35</span>        <span class="n">categorical_features</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span>
<span class="linenos">36</span>            <span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s2">"category"</span><span class="p">,</span> <span class="s2">"object"</span><span class="p">,</span> <span class="s2">"string"</span><span class="p">]</span>
<span class="linenos">37</span>        <span class="p">)</span><span class="o">.</span><span class="n">columns</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="data-7">
            <div class="docs">
                <div class="section-link">
                    <a href="#data-7">#</a>
                </div>
                <p>Process each feature individually</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">38</span>        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
<span class="linenos">39</span>            <span class="n">info</span> <span class="o">=</span> <span class="n">FeatureInfo</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
<span class="linenos">40</span>            <span class="n">values</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">41</span>            <span class="n">category_as_numeric</span> <span class="o">=</span> <span class="kc">False</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="data-8">
            <div class="docs">
                <div class="section-link">
                    <a href="#data-8">#</a>
                </div>
                <p>Handle categorical features</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">42</span>            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">categorical_features</span><span class="p">:</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="data-9">
            <div class="docs">
                <div class="section-link">
                    <a href="#data-9">#</a>
                </div>
                <p>Use pandas' categorical type to get the unique categories.
NaN values are considered as a separate category (-1 code)</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">43</span>                <span class="n">category_col</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">"category"</span><span class="p">)</span>
<span class="linenos">44</span>                <span class="n">info</span><span class="o">.</span><span class="n">categories</span> <span class="o">=</span> <span class="n">category_col</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="data-10">
            <div class="docs">
                <div class="section-link">
                    <a href="#data-10">#</a>
                </div>
                <p>If too many categories, use CatBoost-style target encoding</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">45</span>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">categories</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_categories</span><span class="p">:</span>
<span class="linenos">46</span>                    <span class="n">category_as_numeric</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">47</span>                    <span class="k">assert</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sample_weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="linenos">48</span>                    <span class="n">target_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">average</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="data-11">
            <div class="docs">
                <div class="section-link">
                    <a href="#data-11">#</a>
                </div>
                <p>Convert categories to codes for grouping</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">49</span>                    <span class="n">codes</span> <span class="o">=</span> <span class="n">category_col</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="data-12">
            <div class="docs">
                <div class="section-link">
                    <a href="#data-12">#</a>
                </div>
                <p>Aggregate \(y * w\) and \(w\) by category. Ignore -1 (NaN) codes.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">50</span>                    <span class="n">valid</span> <span class="o">=</span> <span class="n">codes</span> <span class="o">&gt;=</span> <span class="mi">0</span>
<span class="linenos">51</span>                    <span class="n">w_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">bincount</span><span class="p">(</span>
<span class="linenos">52</span>                        <span class="n">codes</span><span class="p">[</span><span class="n">valid</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">sample_weight</span><span class="p">)[</span><span class="n">valid</span><span class="p">]</span>
<span class="linenos">53</span>                    <span class="p">)</span>
<span class="linenos">54</span>                    <span class="n">w_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">bincount</span><span class="p">(</span><span class="n">codes</span><span class="p">[</span><span class="n">valid</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">[</span><span class="n">valid</span><span class="p">])</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="data-13">
            <div class="docs">
                <div class="section-link">
                    <a href="#data-13">#</a>
                </div>
                <p>Compute TS for category \(c\) as:
$$TS(c) = \frac{\sum_{i \in c} w_i y_i + \alpha \cdot \mu}{\sum_{i \in c} w_i + \alpha}$$
where \(\mu\) is the global weighted mean of the target, and \(\alpha\) is
the prior strength.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">55</span>                    <span class="n">info</span><span class="o">.</span><span class="n">target_statistics</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
<span class="linenos">56</span>                        <span class="nb">enumerate</span><span class="p">(</span>
<span class="linenos">57</span>                            <span class="p">(</span><span class="n">w_sum</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior_strength</span> <span class="o">*</span> <span class="n">target_mean</span><span class="p">)</span>
<span class="linenos">58</span>                            <span class="o">/</span> <span class="p">(</span><span class="n">w_total</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior_strength</span><span class="p">)</span>
<span class="linenos">59</span>                        <span class="p">)</span>
<span class="linenos">60</span>                    <span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="data-14">
            <div class="docs">
                <div class="section-link">
                    <a href="#data-14">#</a>
                </div>
                <p>Map the codes to target statistics for binning in the next step</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">61</span>                    <span class="n">values</span> <span class="o">=</span> <span class="n">map_array</span><span class="p">(</span><span class="n">codes</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">target_statistics</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="data-15">
            <div class="docs">
                <div class="section-link">
                    <a href="#data-15">#</a>
                </div>
                <p>It's a categorical feature. No binning needed.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">62</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos">63</span>                    <span class="n">info</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">"categorical"</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="data-16">
            <div class="docs">
                <div class="section-link">
                    <a href="#data-16">#</a>
                </div>
                <p>Bin numerical and categorical-as-numeric features</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">64</span>            <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">categorical_features</span> <span class="ow">or</span> <span class="n">category_as_numeric</span><span class="p">:</span>
<span class="linenos">65</span>                <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">66</span>                    <span class="n">values</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="data-17">
            <div class="docs">
                <div class="section-link">
                    <a href="#data-17">#</a>
                </div>
                <p>Compute quantile-based bins with no interpolation</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">67</span>                <span class="n">quantiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanquantile</span><span class="p">(</span>
<span class="linenos">68</span>                    <span class="n">values</span><span class="p">,</span>
<span class="linenos">69</span>                    <span class="n">np</span><span class="o">.</span><span class="kp">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_bins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
<span class="linenos">70</span>                    <span class="n">method</span><span class="o">=</span><span class="s2">"nearest"</span><span class="p">,</span>
<span class="linenos">71</span>                <span class="p">)</span>
<span class="linenos">72</span>                <span class="n">info</span><span class="o">.</span><span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">unique</span><span class="p">(</span><span class="n">quantiles</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">"float64"</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="data-18">
            <div class="docs">
                <div class="section-link">
                    <a href="#data-18">#</a>
                </div>
                <p>Set feature type</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">73</span>                <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">categorical_features</span><span class="p">:</span>
<span class="linenos">74</span>                    <span class="n">info</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">"category_as_numeric"</span>
<span class="linenos">75</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos">76</span>                    <span class="n">info</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">"numerical"</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="data-19">
            <div class="docs">
                <div class="section-link">
                    <a href="#data-19">#</a>
                </div>
                
            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">77</span>            <span class="n">features_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="data-20">
            <div class="docs">
                <div class="section-link">
                    <a href="#data-20">#</a>
                </div>
                
            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">78</span>        <span class="bp">self</span><span class="o">.</span><span class="n">features_info_</span> <span class="o">=</span> <span class="n">features_info</span>
<span class="linenos">79</span>        <span class="k">return</span> <span class="bp">self</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="data-21">
            <div class="docs">
                <div class="section-link">
                    <a href="#data-21">#</a>
                </div>
                <p>Transform the dataset into a numerical numpy array based on the fitted
feature information.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">80</span>    <span class="k">def</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span>
<span class="linenos">81</span>        <span class="bp">self</span><span class="p">,</span>
<span class="linenos">82</span>        <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
<span class="linenos">83</span>        <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">84</span>        <span class="n">sample_weight</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">85</span>        <span class="n">mode</span><span class="o">=</span><span class="s2">"test"</span><span class="p">,</span>
<span class="linenos">86</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">:</span>
<span class="linenos">87</span>        <span class="n">array</span> <span class="o">=</span> <span class="n">X</span><span class="p">[[</span><span class="n">info</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_info_</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos">88</span>        <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">89</span>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
<span class="linenos">90</span>                <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="linenos">91</span>            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">"float64"</span><span class="p">)</span>
<span class="linenos">92</span>
<span class="linenos">93</span>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features_info_</span><span class="p">):</span>
<span class="linenos">94</span>            <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">"categorical"</span><span class="p">:</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="data-22">
            <div class="docs">
                <div class="section-link">
                    <a href="#data-22">#</a>
                </div>
                <p>Transform categorical features to integer codes. The reason we use
integer code rather than keeping original string values is that the transformed
dataset is supposed to be a homogeneous float64 numpy array.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">95</span>                <span class="n">codes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span>
<span class="linenos">96</span>                    <span class="n">X</span><span class="p">[</span><span class="n">info</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">categories</span>
<span class="linenos">97</span>                <span class="p">)</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">"float64"</span><span class="p">)</span>
<span class="linenos">98</span>                <span class="n">codes</span><span class="p">[</span><span class="n">codes</span> <span class="o">==</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">nan</span>
<span class="linenos">99</span>                <span class="n">array</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">codes</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="data-23">
            <div class="docs">
                <div class="section-link">
                    <a href="#data-23">#</a>
                </div>
                <p>CatBoost-style target statistics encoding. Train and test modes differ.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">100</span>            <span class="k">elif</span> <span class="n">info</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">"category_as_numeric"</span><span class="p">:</span>
<span class="linenos">101</span>                <span class="n">category_col</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">info</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">categories</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="data-24">
            <div class="docs">
                <div class="section-link">
                    <a href="#data-24">#</a>
                </div>
                <p>If test mode, use the precomputed target statistics mapping</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">102</span>                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">"test"</span><span class="p">:</span>
<span class="linenos">103</span>                    <span class="n">array</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">map_array</span><span class="p">(</span><span class="n">category_col</span><span class="o">.</span><span class="n">codes</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">target_statistics</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="data-25">
            <div class="docs">
                <div class="section-link">
                    <a href="#data-25">#</a>
                </div>
                <p>For training mode, compute ordered target statistics averaged over
multiple random permutations</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">104</span>                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">"train"</span><span class="p">:</span>
<span class="linenos">105</span>                    <span class="k">assert</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sample_weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="linenos">106</span>                    <span class="n">target_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">average</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">)</span>
<span class="linenos">107</span>                    <span class="n">codes</span> <span class="o">=</span> <span class="n">category_col</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">"int64"</span><span class="p">)</span>
<span class="linenos">108</span>                    <span class="n">encodings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_permutations</span><span class="p">))</span>
<span class="linenos">109</span>                    <span class="n">n_cats</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">codes</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="data-26">
            <div class="docs">
                <div class="section-link">
                    <a href="#data-26">#</a>
                </div>
                <p>We impose a random order on the data and for every sample \(i\),
compute the target statistic using only samples that come before
it in this random order. This is to avoid target leakage.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">110</span>                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_permutations</span><span class="p">):</span>
<span class="linenos">111</span>                        <span class="n">group_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">zeros</span><span class="p">(</span><span class="n">n_cats</span><span class="p">)</span>
<span class="linenos">112</span>                        <span class="n">group_weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">zeros</span><span class="p">(</span><span class="n">n_cats</span><span class="p">)</span>
<span class="linenos">113</span>                        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)):</span>
<span class="linenos">114</span>                            <span class="n">c</span> <span class="o">=</span> <span class="n">codes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="data-27">
            <div class="docs">
                <div class="section-link">
                    <a href="#data-27">#</a>
                </div>
                <p>If the category is -1 (NaN), assign NaN and continue</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">115</span>                            <span class="k">if</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">116</span>                                <span class="n">encodings</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">nan</span>
<span class="linenos">117</span>                                <span class="k">continue</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="data-28">
            <div class="docs">
                <div class="section-link">
                    <a href="#data-28">#</a>
                </div>
                <p>Same formula as in fit(), but using only previous samples</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">118</span>                            <span class="n">encodings</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">119</span>                                <span class="n">group_sum</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior_strength</span> <span class="o">*</span> <span class="n">target_mean</span>
<span class="linenos">120</span>                            <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">group_weight</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior_strength</span><span class="p">)</span>
<span class="linenos">121</span>                            <span class="n">group_sum</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+=</span> <span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">sample_weight</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
<span class="linenos">122</span>                            <span class="n">group_weight</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+=</span> <span class="n">sample_weight</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="data-29">
            <div class="docs">
                <div class="section-link">
                    <a href="#data-29">#</a>
                </div>
                <p>Average over all permutations</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">123</span>                    <span class="n">array</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">mean</span><span class="p">(</span><span class="n">encodings</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="data-30">
            <div class="docs">
                <div class="section-link">
                    <a href="#data-30">#</a>
                </div>
                
            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">124</span>        <span class="n">array</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">"float64"</span><span class="p">)</span>
<span class="linenos">125</span>        <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">126</span>            <span class="k">return</span> <span class="n">array</span><span class="p">,</span> <span class="n">y</span>
<span class="linenos">127</span>        <span class="k">return</span> <span class="n">array</span></pre></div>

            </div>
        </div>
    
        </div>
    
</div>
</div>
</section>
<section id="node-and-tree-structures" class="level2 page-columns page-full" data-number="4.3">
<h2 data-number="4.3" data-anchor-id="node-and-tree-structures"><span class="header-section-number">4.3</span> Node and Tree Structures</h2>
<p>Here we define the skeleton of a decision tree and its nodes. Each node stores information about split criterion, value, …, and child nodes.</p>
<p>The implementation is kept lean to focus more on the structure rather than optimization details.</p>
<div id="2dd246a8" class="cell no-style-output page-columns page-full" data-execution_count="4">
<div class="cell-output cell-output-display column-page">
<h3 style="margin-top: 0;">tree.py</h3>
        <div class="docfuse ">
            
        <div class="section" id="tree-0">
            <div class="docs">
                <div class="section-link">
                    <a href="#tree-0">#</a>
                </div>
                
            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">1</span><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="linenos">2</span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>
<span class="linenos">3</span>
<span class="linenos">4</span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="tree-1">
            <div class="docs">
                <div class="section-link">
                    <a href="#tree-1">#</a>
                </div>
                <p>A class representing a node in a decision tree.</p>
<p><strong>Attributes</strong></p>
<ul>
<li><code>depth</code> : int
<ul>
<li>The depth of the node in the tree.</li>
</ul>
</li>
<li><code>sample_indices</code> : List[int]
<ul>
<li>The indices of training samples that reach this node. Used during training.</li>
</ul>
</li>
<li><code>parent</code> : Node, optional
<ul>
<li>The parent node. None for the root node.</li>
</ul>
</li>
<li><code>children</code> : Dict[str, Node]
<ul>
<li>The child nodes, typically with keys "left" and "right".</li>
</ul>
</li>
<li><code>gradient_sum</code> : np.ndarray
<ul>
<li>The sum of gradients for samples in this node.</li>
</ul>
</li>
<li><code>hessian_sum</code> : np.ndarray
<ul>
<li>The sum of hessians for samples in this node.</li>
</ul>
</li>
<li><code>l1_regularization</code> : float
<ul>
<li>The L1 regularization term.</li>
</ul>
</li>
<li><code>l2_regularization</code> : float
<ul>
<li>The L2 regularization term.</li>
</ul>
</li>
<li><code>feature</code> : str, optional
<ul>
<li>Feature name used for splitting at this node.</li>
</ul>
</li>
<li><code>feature_index</code> : int, optional
<ul>
<li>Index of the feature in the input array.</li>
</ul>
</li>
<li><code>split_point</code> : Union[float, Tuple], optional
<ul>
<li>The split point for numerical features or a tuple of categories for categorical features.</li>
</ul>
</li>
<li><code>nulls_to_left</code> : bool, optional
<ul>
<li>Whether null values go to the left child.</li>
</ul>
</li>
<li><code>smoothed_value</code> : np.ndarray, optional
<ul>
<li>The smoothed value for the node, used for prediction. Only set for leaf nodes.</li>
</ul>
</li>
<li><code>info</code> : Dict[str, Any]
<ul>
<li>Additional information about the node.</li>
</ul>
</li>
</ul>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos"> 5</span><span class="nd">@dataclass</span>
<span class="linenos"> 6</span><span class="k">class</span><span class="w"> </span><span class="nc">Node</span><span class="p">:</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span>    <span class="n">depth</span><span class="p">:</span> <span class="nb">int</span>
<span class="linenos"> 9</span>    <span class="n">sample_indices</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
<span class="linenos">10</span>    <span class="n">parent</span><span class="p">:</span> <span class="s2">"Node"</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">11</span>    <span class="n">children</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">"Node"</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<span class="linenos">12</span>    <span class="n">gradient_sum</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">13</span>    <span class="n">hessian_sum</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">14</span>    <span class="n">l1_regularization</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos">15</span>    <span class="n">l2_regularization</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos">16</span>    <span class="n">feature</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">17</span>    <span class="n">feature_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">18</span>    <span class="n">split_point</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">19</span>    <span class="n">nulls_to_left</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">20</span>    <span class="n">smoothed_value</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">21</span>    <span class="n">info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="tree-2">
            <div class="docs">
                <div class="section-link">
                    <a href="#tree-2">#</a>
                </div>
                <p>Calculate the leaf value using the formula:
$$ \text{Value} = - \frac{\text{sign}(G) \cdot \max(|G| - \lambda_{\text{L1}}, 0)}{H + \lambda_{\text{L2}}} $$</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">22</span>    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smooth</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="linenos">23</span>        <span class="k">if</span> <span class="n">smooth</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">smoothed_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">24</span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">smoothed_value</span>
<span class="linenos">25</span>
<span class="linenos">26</span>        <span class="n">gradient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_sum</span>
<span class="linenos">27</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1_regularization</span><span class="p">:</span>
<span class="linenos">28</span>            <span class="n">gradient</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">sign</span><span class="p">(</span><span class="n">gradient</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="kp">maximum</span><span class="p">(</span>
<span class="linenos">29</span>                <span class="n">np</span><span class="o">.</span><span class="kp">abs</span><span class="p">(</span><span class="n">gradient</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1_regularization</span><span class="p">,</span> <span class="mf">0.0</span>
<span class="linenos">30</span>            <span class="p">)</span>
<span class="linenos">31</span>        <span class="k">return</span> <span class="o">-</span><span class="n">gradient</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hessian_sum</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2_regularization</span> <span class="o">+</span> <span class="mf">1e-16</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="tree-3">
            <div class="docs">
                <div class="section-link">
                    <a href="#tree-3">#</a>
                </div>
                <p>Returns the type of the node: <code>InternalNode</code>, <code>Leaf</code>, or <code>VirtualNode</code>.
VirtualNode is a special node used only during training to represent nodes that
have not been instantiated yet.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">32</span>    <span class="nd">@property</span>
<span class="linenos">33</span>    <span class="k">def</span><span class="w"> </span><span class="nf">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="linenos">34</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
<span class="linenos">35</span>            <span class="k">return</span> <span class="s2">"InternalNode"</span>
<span class="linenos">36</span>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_sum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hessian_sum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">37</span>            <span class="k">return</span> <span class="s2">"Leaf"</span>
<span class="linenos">38</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">39</span>            <span class="k">return</span> <span class="s2">"VirtualNode"</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="tree-4">
            <div class="docs">
                <div class="section-link">
                    <a href="#tree-4">#</a>
                </div>
                <p>Returns a boolean mask indicating which samples go to the left child.</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>array</code> : np.ndarray
<ul>
<li>The input feature array.</li>
</ul>
</li>
<li><code>input_type</code> : str, default="all"
<ul>
<li>Specifies whether the input array contains all features ("all") or just the feature
used for splitting ("feature").</li>
</ul>
</li>
</ul>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">40</span>    <span class="k">def</span><span class="w"> </span><span class="nf">criterion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span> <span class="n">input_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"all"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">:</span>
<span class="linenos">41</span>        <span class="k">if</span> <span class="n">input_type</span> <span class="o">==</span> <span class="s2">"all"</span><span class="p">:</span>
<span class="linenos">42</span>            <span class="n">array</span> <span class="o">=</span> <span class="n">array</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_index</span><span class="p">]</span>
<span class="linenos">43</span>        <span class="n">null_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">isnan</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nulls_to_left</span>
<span class="linenos">44</span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">split_point</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
<span class="linenos">45</span>            <span class="k">return</span> <span class="n">null_mask</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_point</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos">46</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">47</span>            <span class="k">return</span> <span class="n">null_mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">array</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_point</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="tree-5">
            <div class="docs">
                <div class="section-link">
                    <a href="#tree-5">#</a>
                </div>
                <p>String representation of the node. Used for visualization and debugging.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">48</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">49</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
<span class="linenos">50</span>            <span class="k">return</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">(feature='</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="si">}</span><span class="s2">', split_point=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">split_point</span><span class="si">}</span><span class="s2">, samples=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_indices</span><span class="p">)</span><span class="si">}</span><span class="s2">)"</span>
<span class="linenos">51</span>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_sum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hessian_sum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">52</span>            <span class="k">return</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">(value=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">()</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="s2">, samples=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_indices</span><span class="p">)</span><span class="si">}</span><span class="s2">)"</span>
<span class="linenos">53</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">54</span>            <span class="k">return</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">(samples=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_indices</span><span class="p">)</span><span class="si">}</span><span class="s2">)"</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="tree-6">
            <div class="docs">
                <div class="section-link">
                    <a href="#tree-6">#</a>
                </div>
                <p>Helper method to update a dataclass's fields.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">55</span>    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="linenos">56</span>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos">57</span>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="linenos">58</span>                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Node has no attribute '</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
<span class="linenos">59</span>            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="tree-7">
            <div class="docs">
                <div class="section-link">
                    <a href="#tree-7">#</a>
                </div>
                <p>A structure representing a decision tree.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">60</span><span class="k">class</span><span class="w"> </span><span class="nc">Tree</span><span class="p">:</span>
<span class="linenos">61</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">:</span> <span class="n">Node</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos">62</span>        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="tree-8">
            <div class="docs">
                <div class="section-link">
                    <a href="#tree-8">#</a>
                </div>
                <p>Make predictions for the input samples <code>x</code> starting from the given node (or root if None).
We traverse the tree from the root to the leaves based on the split criteria at each node, and aggregate
the leaf values to produce the final predictions.</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>x</code> : np.ndarray
<ul>
<li>The input samples for which predictions are to be made, with shape (n_samples, n_features).</li>
</ul>
</li>
<li><code>node</code> : Node, optional
<ul>
<li>The current node in the tree from which to start predictions. If None, starts from the root node.</li>
</ul>
</li>
</ul>
<p><strong>Returns</strong></p>
<ul>
<li><code>output</code> : np.ndarray
<ul>
<li>The leaf values for each input sample, with shape (n_samples, n_outputs).</li>
</ul>
</li>
</ul>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">63</span>    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Node</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos">64</span>        <span class="n">node</span> <span class="o">=</span> <span class="n">node</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span>
<span class="linenos">65</span>        <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="tree-9">
            <div class="docs">
                <div class="section-link">
                    <a href="#tree-9">#</a>
                </div>
                <p>If the node is an internal node, split the samples and recurse</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">66</span>        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
<span class="linenos">67</span>            <span class="n">mask</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">criterion</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="linenos">68</span>            <span class="n">n_output</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s2">"left"</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">())</span>
<span class="linenos">69</span>            <span class="n">output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">zeros</span><span class="p">((</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">n_output</span><span class="p">))</span>
<span class="linenos">70</span>            <span class="n">output</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s2">"left"</span><span class="p">])</span>
<span class="linenos">71</span>            <span class="n">output</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">],</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s2">"right"</span><span class="p">])</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="tree-10">
            <div class="docs">
                <div class="section-link">
                    <a href="#tree-10">#</a>
                </div>
                <p>If in the leaf node, return the leaf value for all samples</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">72</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">73</span>            <span class="n">output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">tile</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">(),</span> <span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="linenos">74</span>        <span class="k">return</span> <span class="n">output</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="tree-11">
            <div class="docs">
                <div class="section-link">
                    <a href="#tree-11">#</a>
                </div>
                <p>Returns the number of leaves in the tree.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">75</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">76</span>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">leaves</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="tree-12">
            <div class="docs">
                <div class="section-link">
                    <a href="#tree-12">#</a>
                </div>
                <p>Iterator to traverse all nodes in the tree using depth-first search.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">77</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="tree-13">
            <div class="docs">
                <div class="section-link">
                    <a href="#tree-13">#</a>
                </div>
                <p>Utility for traversal of the tree. Since it's a recursive generator, we need
to use <code>yield</code> instead of <code>return</code> to yield nodes one by one. On a similar note,
<code>yield from</code> is used for calling the generator recursively.
It's a rarely used syntax but I find it a neat feature of Python :)</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">78</span>        <span class="k">def</span><span class="w"> </span><span class="nf">dfs</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">):</span>
<span class="linenos">79</span>            <span class="k">yield</span> <span class="n">node</span>
<span class="linenos">80</span>            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<span class="linenos">81</span>                <span class="k">yield from</span> <span class="n">dfs</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
<span class="linenos">82</span>
<span class="linenos">83</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">:</span>
<span class="linenos">84</span>            <span class="k">yield from</span> <span class="n">dfs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="tree-14">
            <div class="docs">
                <div class="section-link">
                    <a href="#tree-14">#</a>
                </div>
                <p>Returns a list of all leaf nodes in the tree. We use the <strong>iter</strong> method to traverse the tree.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">85</span>    <span class="nd">@property</span>
<span class="linenos">86</span>    <span class="k">def</span><span class="w"> </span><span class="nf">leaves</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Node</span><span class="p">]:</span>
<span class="linenos">87</span>        <span class="k">return</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">"Leaf"</span><span class="p">]</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="tree-15">
            <div class="docs">
                <div class="section-link">
                    <a href="#tree-15">#</a>
                </div>
                <p>Apply exponential path smoothing to all leaf values (in-place).</p>
<p>Blends each leaf with ancestors using exponential decay: leaf gets weight 1,
parent gets \(\beta\), grandparent gets \(\beta^2\), etc.</p>
<p>$$v_{\text{smoothed}} = \frac{\sum_{i=0}^{d} \beta^{d-i} \cdot v_i}{\sum_{i=0}^{d} \beta^{d-i}}$$</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>beta</code> : float in (0, 1], default=0.5
<ul>
<li>Decay factor. Lower values = stronger regularization toward shallow predictions.</li>
</ul>
</li>
</ul>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">88</span>    <span class="k">def</span><span class="w"> </span><span class="nf">apply_smoothing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beta</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="tree-16">
            <div class="docs">
                <div class="section-link">
                    <a href="#tree-16">#</a>
                </div>
                
            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">89</span>        <span class="k">def</span><span class="w"> </span><span class="nf">dfs</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">weighted_sum</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span> <span class="n">weight_total</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="tree-17">
            <div class="docs">
                <div class="section-link">
                    <a href="#tree-17">#</a>
                </div>
                <p>Add current node's contribution</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">90</span>            <span class="n">weighted_sum</span> <span class="o">=</span> <span class="n">weighted_sum</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">smooth</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos">91</span>            <span class="n">weight_total</span> <span class="o">=</span> <span class="n">weight_total</span> <span class="o">+</span> <span class="mf">1.0</span>
<span class="linenos">92</span>
<span class="linenos">93</span>            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">"Leaf"</span><span class="p">:</span>
<span class="linenos">94</span>                <span class="n">node</span><span class="o">.</span><span class="n">smoothed_value</span> <span class="o">=</span> <span class="n">weighted_sum</span> <span class="o">/</span> <span class="n">weight_total</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="tree-18">
            <div class="docs">
                <div class="section-link">
                    <a href="#tree-18">#</a>
                </div>
                <p>Discount contributions from ancestors and recurse</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">95</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">96</span>                <span class="n">weighted_sum</span> <span class="o">=</span> <span class="n">weighted_sum</span> <span class="o">*</span> <span class="n">beta</span>
<span class="linenos">97</span>                <span class="n">weight_total</span> <span class="o">=</span> <span class="n">weight_total</span> <span class="o">*</span> <span class="n">beta</span>
<span class="linenos">98</span>                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<span class="linenos">99</span>                    <span class="n">dfs</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">weighted_sum</span><span class="p">,</span> <span class="n">weight_total</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="tree-19">
            <div class="docs">
                <div class="section-link">
                    <a href="#tree-19">#</a>
                </div>
                
            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">100</span>        <span class="n">initial_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">smooth</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="linenos">101</span>        <span class="n">dfs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">initial_sum</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="tree-20">
            <div class="docs">
                <div class="section-link">
                    <a href="#tree-20">#</a>
                </div>
                <p>Print the tree structure in a readable format.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">102</span>    <span class="k">def</span><span class="w"> </span><span class="nf">print</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">"Root: "</span><span class="p">):</span>
<span class="linenos">103</span>        <span class="n">node</span> <span class="o">=</span> <span class="n">node</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span>
<span class="linenos">104</span>        <span class="nb">print</span><span class="p">(</span><span class="s2">" "</span> <span class="o">*</span> <span class="p">(</span><span class="n">level</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">prefix</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
<span class="linenos">105</span>        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
<span class="linenos">106</span>            <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"left"</span><span class="p">),</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">"L--- "</span><span class="p">)</span>
<span class="linenos">107</span>            <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"right"</span><span class="p">),</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">"R--- "</span><span class="p">)</span></pre></div>

            </div>
        </div>
    
        </div>
    
</div>
</div>
</section>
<section id="tree-optimization" class="level2 page-columns page-full" data-number="4.4">
<h2 data-number="4.4" data-anchor-id="tree-optimization"><span class="header-section-number">4.4</span> Tree Optimization</h2>
<p>This module implements the core logic for creating decision trees used in Gradient Boosted Trees. The class <code>TreeGrower</code> is responsible for growing the tree by finding the best splits based on the gradients and hessians. I stole the name “TreeGrower” from Sklearn’s implementation, but not sure if they were the first.</p>
<p>The flow of the algorithm is as follows:</p>
<ol type="1">
<li>Subsample the data if specified. This is to introduce randomness and prevent overfitting. Training on different subsets of sample and features results in a more diverse set of trees.</li>
<li>Initialize the root node.</li>
<li>Use a priority queue to keep track of all node candidates to be split, and prioritize them based on their potential to reduce loss.</li>
<li>Iteratively:
<ul>
<li>Evaluate the best split and gain for the unprocessed nodes, and update the priority queue.</li>
<li>Select the node with the highest gain from the priority queue to split. Update its information, and create its child nodes to be processed in the next iteration.</li>
<li>Stop when the maximum number of leaves is reached, or no more beneficial splits are found.</li>
</ul></li>
</ol>
<p>This is called leaf-wise growth, as opposed to level-wise growth in traditional XGBoost, and also CatBoost since it uses oblivious trees (as far as I know).</p>
<div id="ea18a10c" class="cell no-style-output page-columns page-full" data-execution_count="5">
<div class="cell-output cell-output-display column-page">
<h3 style="margin-top: 0;">grower.py</h3>
        <div class="docfuse ">
            
        <div class="section" id="grower-0">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-0">#</a>
                </div>
                
            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos"> 1</span><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="linenos"> 2</span><span class="kn">from</span><span class="w"> </span><span class="nn">queue</span><span class="w"> </span><span class="kn">import</span> <span class="n">PriorityQueue</span>
<span class="linenos"> 3</span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="kn">from</span><span class="w"> </span><span class="nn">.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">FeatureInfo</span>
<span class="linenos"> 8</span><span class="kn">from</span><span class="w"> </span><span class="nn">.tree</span><span class="w"> </span><span class="kn">import</span> <span class="n">Node</span><span class="p">,</span> <span class="n">Tree</span>
<span class="linenos"> 9</span><span class="kn">from</span><span class="w"> </span><span class="nn">.distributions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Distribution</span>
<span class="linenos">10</span><span class="kn">from</span><span class="w"> </span><span class="nn">.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">groupby_sum_2d</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-1">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-1">#</a>
                </div>
                <h3>SplitCandidate</h3>
<p>A class to store information about a potential node split during tree growth.</p>
<p><strong>Attributes</strong></p>
<ul>
<li><code>gain</code> : float
<ul>
<li>The gain achieved by this split.</li>
</ul>
</li>
<li><code>feature</code> : str
<ul>
<li>The feature on which to split.</li>
</ul>
</li>
<li><code>feature_index</code> : int
<ul>
<li>The index of the feature in the input array.</li>
</ul>
</li>
<li><code>split_point</code> : Union[float, Tuple]
<ul>
<li>For numerical features, the threshold value. For categorical features, a tuple of
two arrays representing the left and right category groups.</li>
</ul>
</li>
<li><code>nulls_to_left</code> : bool
<ul>
<li>Whether null values go to the left child.</li>
</ul>
</li>
<li><code>gradient_sum</code> : np.ndarray
<ul>
<li>The sum of gradients for samples in the node.</li>
</ul>
</li>
<li><code>hessian_sum</code> : np.ndarray
<ul>
<li>The sum of hessians for samples in the node.</li>
</ul>
</li>
<li><code>left_grad_sum</code> : np.ndarray
<ul>
<li>The sum of gradients for samples going to the left child.</li>
</ul>
</li>
<li><code>left_hess_sum</code> : np.ndarray
<ul>
<li>The sum of hessians for samples going to the left child.</li>
</ul>
</li>
</ul>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">11</span><span class="nd">@dataclass</span>
<span class="linenos">12</span><span class="k">class</span><span class="w"> </span><span class="nc">SplitCandidate</span><span class="p">:</span>
<span class="linenos">13</span>
<span class="linenos">14</span>    <span class="n">gain</span><span class="p">:</span> <span class="nb">float</span>
<span class="linenos">15</span>    <span class="n">feature</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">16</span>    <span class="n">feature_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">17</span>    <span class="n">split_point</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">18</span>    <span class="n">nulls_to_left</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">19</span>    <span class="n">gradient_sum</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">20</span>    <span class="n">hessian_sum</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">21</span>    <span class="n">left_grad_sum</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">22</span>    <span class="n">left_hess_sum</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span> <span class="o">=</span> <span class="kc">None</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-2">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-2">#</a>
                </div>
                
            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">23</span>    <span class="nd">@property</span>
<span class="linenos">24</span>    <span class="k">def</span><span class="w"> </span><span class="nf">right_grad_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">:</span>
<span class="linenos">25</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_sum</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">left_grad_sum</span>
<span class="linenos">26</span>
<span class="linenos">27</span>    <span class="nd">@property</span>
<span class="linenos">28</span>    <span class="k">def</span><span class="w"> </span><span class="nf">right_hess_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">:</span>
<span class="linenos">29</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hessian_sum</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">left_hess_sum</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-3">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-3">#</a>
                </div>
                <h3>TreeGrower</h3>
<p>A class to grow decision trees. The core logic for finding the best splits and constructing
the tree structure is implemented here.</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>distribution</code> : Distribution
<ul>
<li>The objective function defining the loss and gradient/hessian computations.</li>
</ul>
</li>
<li><code>learning_rate</code> : float
<ul>
<li>The learning rate for boosting.</li>
</ul>
</li>
<li><code>max_leaves</code> : int
<ul>
<li>The maximum number of leaves in the tree.</li>
</ul>
</li>
<li><code>max_depth</code> : int
<ul>
<li>The maximum depth of the tree.</li>
</ul>
</li>
<li><code>min_samples_split</code> : int
<ul>
<li>The minimum number of samples required to split a node.</li>
</ul>
</li>
<li><code>min_gain_to_split</code> : float
<ul>
<li>The minimum gain required to perform a split.</li>
</ul>
</li>
<li><code>l1_regularization</code> : float
<ul>
<li>The L1 regularization term for leaf value calculation.</li>
</ul>
</li>
<li><code>l2_regularization</code> : float
<ul>
<li>The L2 regularization term for leaf value calculation.</li>
</ul>
</li>
<li><code>min_weight_leaf</code> : float
<ul>
<li>The minimum sum of instance weights required in a leaf node.</li>
</ul>
</li>
<li><code>feature_fraction</code> : float
<ul>
<li>The fraction of features to consider when looking for the best split.</li>
</ul>
</li>
<li><code>samples_fraction</code> : float
<ul>
<li>The fraction of samples to consider when growing the tree.</li>
</ul>
</li>
<li><code>goss_top_rate</code> : float
<ul>
<li>The top rate for Gradient-based One-Side Sampling (GOSS).</li>
</ul>
</li>
<li><code>goss_bottom_rate</code> : float
<ul>
<li>The bottom rate for GOSS.</li>
</ul>
</li>
<li><code>goss_rescale_bottom</code> : bool
<ul>
<li>Whether to rescale the bottom samples in GOSS.</li>
</ul>
</li>
<li><code>objective_weight</code> : List[float]
<ul>
<li>Weights for multi-output objectives.</li>
</ul>
</li>
<li><code>n_workers</code> : int
<ul>
<li>The number of parallel workers to use for finding splits.</li>
</ul>
</li>
<li><code>seed</code> : int
<ul>
<li>Random seed for reproducibility.</li>
</ul>
</li>
</ul>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">30</span><span class="nd">@dataclass</span>
<span class="linenos">31</span><span class="k">class</span><span class="w"> </span><span class="nc">TreeGrower</span><span class="p">:</span>
<span class="linenos">32</span>
<span class="linenos">33</span>    <span class="n">distribution</span><span class="p">:</span> <span class="n">Distribution</span>
<span class="linenos">34</span>    <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span>
<span class="linenos">35</span>    <span class="n">max_leaves</span><span class="p">:</span> <span class="nb">int</span>
<span class="linenos">36</span>    <span class="n">max_depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span>
<span class="linenos">37</span>    <span class="n">min_samples_split</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>
<span class="linenos">38</span>    <span class="n">min_gain_to_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos">39</span>    <span class="n">l1_regularization</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos">40</span>    <span class="n">l2_regularization</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos">41</span>    <span class="n">min_weight_leaf</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">"-inf"</span><span class="p">)</span>
<span class="linenos">42</span>    <span class="n">feature_fraction</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="linenos">43</span>    <span class="n">samples_fraction</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="linenos">44</span>    <span class="n">goss_top_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">45</span>    <span class="n">goss_bottom_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">46</span>    <span class="n">goss_rescale_bottom</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">47</span>    <span class="n">objective_weight</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">48</span>    <span class="n">n_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">49</span>    <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-4">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-4">#</a>
                </div>
                <p>Initialize the random state for rng operations</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">50</span>    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">51</span>        <span class="bp">self</span><span class="o">.</span><span class="n">random</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-5">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-5">#</a>
                </div>
                <p>Train a decision tree using the provided dataset.</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>inputs</code> : np.ndarray
<ul>
<li>The input feature array.</li>
</ul>
</li>
<li><code>features_info</code> : List[FeatureInfo]
<ul>
<li>List of FeatureInfo objects describing each feature.</li>
</ul>
</li>
<li><code>targets</code> : np.ndarray
<ul>
<li>The target values.</li>
</ul>
</li>
<li><code>sample_weight</code> : np.ndarray
<ul>
<li>Sample weights for each instance.</li>
</ul>
</li>
<li><code>current_predictions</code> : np.ndarray
<ul>
<li>The current predictions from the ensemble. The goal of adding a new tree is to
correct these predictions.</li>
</ul>
</li>
</ul>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">52</span>    <span class="k">def</span><span class="w"> </span><span class="nf">grow</span><span class="p">(</span>
<span class="linenos">53</span>        <span class="bp">self</span><span class="p">,</span>
<span class="linenos">54</span>        <span class="n">inputs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span>
<span class="linenos">55</span>        <span class="n">features_info</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s2">"FeatureInfo"</span><span class="p">],</span>
<span class="linenos">56</span>        <span class="n">targets</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span>
<span class="linenos">57</span>        <span class="n">sample_weight</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span>
<span class="linenos">58</span>        <span class="n">current_predictions</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span>
<span class="linenos">59</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tree</span><span class="p">:</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-6">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-6">#</a>
                </div>
                <p>Subsample features and samples if required</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">60</span>        <span class="n">inputs</span><span class="p">,</span> <span class="n">features_info</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">sample_weight</span><span class="p">,</span> <span class="n">current_predictions</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">61</span>            <span class="bp">self</span><span class="o">.</span><span class="n">subsample_dataset</span><span class="p">(</span>
<span class="linenos">62</span>                <span class="n">inputs</span><span class="p">,</span>
<span class="linenos">63</span>                <span class="n">features_info</span><span class="p">,</span>
<span class="linenos">64</span>                <span class="n">targets</span><span class="p">,</span>
<span class="linenos">65</span>                <span class="n">sample_weight</span><span class="p">,</span>
<span class="linenos">66</span>                <span class="n">current_predictions</span><span class="p">,</span>
<span class="linenos">67</span>            <span class="p">)</span>
<span class="linenos">68</span>        <span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-7">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-7">#</a>
                </div>
                <p>Default sample weights to 1 if not provided</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">69</span>        <span class="k">if</span> <span class="n">sample_weight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">70</span>            <span class="n">sample_weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-8">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-8">#</a>
                </div>
                <p>Compute gradients and hessians for the samples in the node</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">71</span>        <span class="n">gradient</span><span class="p">,</span> <span class="n">hessian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">gradient_hessian</span><span class="p">(</span>
<span class="linenos">72</span>            <span class="n">targets</span><span class="p">,</span>
<span class="linenos">73</span>            <span class="n">current_predictions</span><span class="p">,</span>
<span class="linenos">74</span>            <span class="n">sample_weight</span><span class="p">,</span>
<span class="linenos">75</span>        <span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-9">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-9">#</a>
                </div>
                <p>NOTE: I don't have a scientific justification for this clipping, but I wanted to avoid
having division by zero errors during gain calculation, and I also saw XGBoost do something
similar. Will have to revisit this later.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">76</span>        <span class="n">hessian</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">maximum</span><span class="p">(</span><span class="n">hessian</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-10">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-10">#</a>
                </div>
                <p>GOSS Sampling</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">77</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">goss_top_rate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">goss_bottom_rate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">78</span>            <span class="p">(</span>
<span class="linenos">79</span>                <span class="n">gradient</span><span class="p">,</span>
<span class="linenos">80</span>                <span class="n">hessian</span><span class="p">,</span>
<span class="linenos">81</span>                <span class="n">inputs</span><span class="p">,</span>
<span class="linenos">82</span>                <span class="n">targets</span><span class="p">,</span>
<span class="linenos">83</span>                <span class="n">sample_weight</span><span class="p">,</span>
<span class="linenos">84</span>            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_goss_sampling</span><span class="p">(</span>
<span class="linenos">85</span>                <span class="n">gradient</span><span class="p">,</span> <span class="n">hessian</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">sample_weight</span>
<span class="linenos">86</span>            <span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-11">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-11">#</a>
                </div>
                <p>Initialize the tree with a root node</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">87</span>        <span class="n">root</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span>
<span class="linenos">88</span>            <span class="n">depth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="linenos">89</span>            <span class="n">l2_regularization</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">l2_regularization</span><span class="p">,</span>
<span class="linenos">90</span>            <span class="n">sample_indices</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="kp">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">)),</span>
<span class="linenos">91</span>        <span class="p">)</span>
<span class="linenos">92</span>        <span class="n">tree</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">root</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-12">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-12">#</a>
                </div>
                <p>Priority queue to store split candidates. Higher gain splits have higher priority.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">93</span>        <span class="n">candidates</span> <span class="o">=</span> <span class="n">PriorityQueue</span><span class="p">()</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-13">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-13">#</a>
                </div>
                <p>Start growing the tree</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">94</span>        <span class="n">leaves_to_process</span> <span class="o">=</span> <span class="p">[</span><span class="n">root</span><span class="p">]</span>
<span class="linenos">95</span>        <span class="n">n_processed</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">96</span>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_leaves</span><span class="p">):</span>
<span class="linenos">97</span>            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">leaves_to_process</span><span class="p">:</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-14">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-14">#</a>
                </div>
                <p>Check if node can be split</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos"> 98</span>                <span class="k">if</span> <span class="p">(</span>
<span class="linenos"> 99</span>                    <span class="n">node</span><span class="o">.</span><span class="n">depth</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span>
<span class="linenos">100</span>                    <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">sample_indices</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_samples_split</span>
<span class="linenos">101</span>                <span class="p">):</span>
<span class="linenos">102</span>                    <span class="k">continue</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-15">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-15">#</a>
                </div>
                <p>Find the best split for the given node</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">103</span>                <span class="n">split_candidate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_best_split</span><span class="p">(</span>
<span class="linenos">104</span>                    <span class="n">inputs</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">sample_indices</span><span class="p">],</span>
<span class="linenos">105</span>                    <span class="n">features_info</span><span class="p">,</span>
<span class="linenos">106</span>                    <span class="n">gradient</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">sample_indices</span><span class="p">],</span>
<span class="linenos">107</span>                    <span class="n">hessian</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">sample_indices</span><span class="p">],</span>
<span class="linenos">108</span>                    <span class="n">sample_weight</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">sample_indices</span><span class="p">],</span>
<span class="linenos">109</span>                <span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-16">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-16">#</a>
                </div>
                <p>Add the split proposal to the queue if it satisfies min gain</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">110</span>                <span class="k">if</span> <span class="p">(</span><span class="n">split_candidate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
<span class="linenos">111</span>                    <span class="n">split_candidate</span><span class="o">.</span><span class="n">gain</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_gain_to_split</span>
<span class="linenos">112</span>                <span class="p">):</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-17">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-17">#</a>
                </div>
                <p>The queue stores tuples of the form (-gain, node_index, node, split_candidate) since
PriorityQueue in Python sorts in ascending order.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">113</span>                    <span class="n">candidates</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
<span class="linenos">114</span>                        <span class="p">(</span>
<span class="linenos">115</span>                            <span class="o">-</span><span class="n">split_candidate</span><span class="o">.</span><span class="n">gain</span><span class="p">,</span>
<span class="linenos">116</span>                            <span class="n">n_processed</span><span class="p">,</span>  <span class="c1"># tie-breaker</span>
<span class="linenos">117</span>                            <span class="n">node</span><span class="p">,</span>
<span class="linenos">118</span>                            <span class="n">split_candidate</span><span class="p">,</span>
<span class="linenos">119</span>                        <span class="p">)</span>
<span class="linenos">120</span>                    <span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-18">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-18">#</a>
                </div>
                
            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">121</span>                <span class="n">n_processed</span> <span class="o">+=</span> <span class="mi">1</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-19">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-19">#</a>
                </div>
                
            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">122</span>            <span class="n">leaves_to_process</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">123</span>            <span class="k">if</span> <span class="n">candidates</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
<span class="linenos">124</span>                <span class="k">break</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-20">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-20">#</a>
                </div>
                <p>Get the global best split candidate</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">125</span>            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">split_info</span> <span class="o">=</span> <span class="n">candidates</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="linenos">126</span>            <span class="bp">self</span><span class="o">.</span><span class="n">split_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">features_info</span><span class="p">,</span> <span class="n">split_info</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-21">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-21">#</a>
                </div>
                <p>Add children to the list for processing in the next iteration</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">127</span>            <span class="n">leaves_to_process</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">values</span><span class="p">())</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-22">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-22">#</a>
                </div>
                
            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">128</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">129</span>            <span class="nb">print</span><span class="p">(</span><span class="s2">"No splits were made; returning None"</span><span class="p">)</span>
<span class="linenos">130</span>            <span class="k">return</span> <span class="kc">None</span>
<span class="linenos">131</span>        <span class="k">return</span> <span class="n">tree</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-23">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-23">#</a>
                </div>
                <p>Find the best split for the given node. This is a helper method that can evaluate each
feature in parallel and aggregate the results.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">132</span>    <span class="k">def</span><span class="w"> </span><span class="nf">find_best_split</span><span class="p">(</span>
<span class="linenos">133</span>        <span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">features_info</span><span class="p">,</span> <span class="n">gradient</span><span class="p">,</span> <span class="n">hessian</span><span class="p">,</span> <span class="n">sample_weight</span>
<span class="linenos">134</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SplitCandidate</span><span class="p">:</span>
<span class="linenos">135</span>        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos">136</span>            <span class="p">(</span>
<span class="linenos">137</span>                <span class="n">info</span><span class="p">,</span>
<span class="linenos">138</span>                <span class="n">inputs</span><span class="p">[:,</span> <span class="n">index</span><span class="p">],</span>
<span class="linenos">139</span>                <span class="n">gradient</span><span class="p">,</span>
<span class="linenos">140</span>                <span class="n">hessian</span><span class="p">,</span>
<span class="linenos">141</span>                <span class="n">sample_weight</span><span class="p">,</span>
<span class="linenos">142</span>            <span class="p">)</span>
<span class="linenos">143</span>            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">features_info</span><span class="p">)</span>
<span class="linenos">144</span>        <span class="p">]</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-24">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-24">#</a>
                </div>
                <p>Parallelize feature processing if n_workers &gt; 1. Otherwise, process sequentially.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">145</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_workers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_workers</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">146</span>            <span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>
<span class="linenos">147</span>
<span class="linenos">148</span>            <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
<span class="linenos">149</span>                <span class="n">feature_results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
<span class="linenos">150</span>                    <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_feature</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">),</span> <span class="n">tasks</span><span class="p">)</span>
<span class="linenos">151</span>                <span class="p">)</span>
<span class="linenos">152</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">153</span>            <span class="n">feature_results</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_process_feature</span><span class="p">(</span><span class="o">*</span><span class="n">task</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">]</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-25">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-25">#</a>
                </div>
                <p>Return the best result</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">154</span>        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span>
<span class="linenos">155</span>            <span class="p">(</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">feature_results</span> <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">),</span>
<span class="linenos">156</span>            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">gain</span><span class="p">,</span>
<span class="linenos">157</span>            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos">158</span>        <span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-26">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-26">#</a>
                </div>
                <p>Find the best split for a given feature. This part is the backbone of the optimization.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">159</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_process_feature</span><span class="p">(</span>
<span class="linenos">160</span>        <span class="bp">self</span><span class="p">,</span>
<span class="linenos">161</span>        <span class="n">info</span><span class="p">:</span> <span class="s2">"FeatureInfo"</span><span class="p">,</span>
<span class="linenos">162</span>        <span class="n">values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span>
<span class="linenos">163</span>        <span class="n">gradient</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span>
<span class="linenos">164</span>        <span class="n">hessian</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span>
<span class="linenos">165</span>        <span class="n">sample_weight</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span>
<span class="linenos">166</span>    <span class="p">):</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-27">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-27">#</a>
                </div>
                <p>Handle categorical and numerical features differently</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">167</span>        <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">"categorical"</span><span class="p">:</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-28">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-28">#</a>
                </div>
                <p>Calculate group-wise sums of gradients and hessians for each category</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">168</span>            <span class="n">cats</span><span class="p">,</span> <span class="n">cat_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">unique</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">169</span>            <span class="n">groups</span> <span class="o">=</span> <span class="n">cats</span>
<span class="linenos">170</span>            <span class="n">grad_group</span><span class="p">,</span> <span class="n">hess_group</span><span class="p">,</span> <span class="n">weight_group</span> <span class="o">=</span> <span class="n">groupby_sum_2d</span><span class="p">(</span>
<span class="linenos">171</span>                <span class="n">n_groups</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">),</span>
<span class="linenos">172</span>                <span class="n">group_indices</span><span class="o">=</span><span class="n">cat_indices</span><span class="p">,</span>
<span class="linenos">173</span>                <span class="n">gradients</span><span class="o">=</span><span class="n">gradient</span><span class="p">,</span>
<span class="linenos">174</span>                <span class="n">hessians</span><span class="o">=</span><span class="n">hessian</span><span class="p">,</span>
<span class="linenos">175</span>                <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">,</span>
<span class="linenos">176</span>            <span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-29">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-29">#</a>
                </div>
                <p>Sort categories by gain to convert categorical split into a
ordered split problem: categories[:k] vs categories[k:].</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">177</span>            <span class="n">fisher_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_gain</span><span class="p">(</span><span class="n">grad_group</span><span class="p">,</span> <span class="n">hess_group</span><span class="p">)</span>
<span class="linenos">178</span>            <span class="n">sort_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">argsort</span><span class="p">(</span><span class="n">fisher_order</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-30">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-30">#</a>
                </div>
                <p>Reorder arrays based on the calculated order</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">179</span>            <span class="n">groups</span><span class="p">,</span> <span class="n">grad_group</span><span class="p">,</span> <span class="n">hess_group</span><span class="p">,</span> <span class="n">weight_group</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">180</span>                <span class="n">groups</span><span class="p">[</span><span class="n">sort_indices</span><span class="p">],</span>
<span class="linenos">181</span>                <span class="n">grad_group</span><span class="p">[</span><span class="n">sort_indices</span><span class="p">],</span>
<span class="linenos">182</span>                <span class="n">hess_group</span><span class="p">[</span><span class="n">sort_indices</span><span class="p">],</span>
<span class="linenos">183</span>                <span class="n">weight_group</span><span class="p">[</span><span class="n">sort_indices</span><span class="p">],</span>
<span class="linenos">184</span>            <span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-31">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-31">#</a>
                </div>
                
            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">185</span>        <span class="k">else</span><span class="p">:</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-32">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-32">#</a>
                </div>
                <p>For numerical features, bin the values first and then compute group-wise sums</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">186</span>            <span class="n">bins</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">bins</span>
<span class="linenos">187</span>            <span class="n">bin_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">digitize</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">188</span>            <span class="n">bin_indices</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="kp">isnan</span><span class="p">(</span><span class="n">values</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span>
<span class="linenos">189</span>            <span class="n">groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">concatenate</span><span class="p">([</span><span class="n">bins</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="kp">nan</span><span class="p">]])</span>
<span class="linenos">190</span>
<span class="linenos">191</span>            <span class="n">grad_group</span><span class="p">,</span> <span class="n">hess_group</span><span class="p">,</span> <span class="n">weight_group</span> <span class="o">=</span> <span class="n">groupby_sum_2d</span><span class="p">(</span>
<span class="linenos">192</span>                <span class="n">n_groups</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">),</span>
<span class="linenos">193</span>                <span class="n">group_indices</span><span class="o">=</span><span class="n">bin_indices</span><span class="p">,</span>
<span class="linenos">194</span>                <span class="n">gradients</span><span class="o">=</span><span class="n">gradient</span><span class="p">,</span>
<span class="linenos">195</span>                <span class="n">hessians</span><span class="o">=</span><span class="n">hessian</span><span class="p">,</span>
<span class="linenos">196</span>                <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">,</span>
<span class="linenos">197</span>            <span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-33">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-33">#</a>
                </div>
                <p>Separate out the null group</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">198</span>        <span class="n">null_group</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">isnan</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
<span class="linenos">199</span>        <span class="n">grad_null_sum</span> <span class="o">=</span> <span class="n">grad_group</span><span class="p">[</span><span class="n">null_group</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">200</span>        <span class="n">hess_null_sum</span> <span class="o">=</span> <span class="n">hess_group</span><span class="p">[</span><span class="n">null_group</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">201</span>        <span class="n">weight_null_sum</span> <span class="o">=</span> <span class="n">weight_group</span><span class="p">[</span><span class="n">null_group</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-34">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-34">#</a>
                </div>
                <p>Calculate cumulative sums excluding the null group</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">202</span>        <span class="n">groups</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="o">~</span><span class="n">null_group</span><span class="p">]</span>
<span class="linenos">203</span>        <span class="n">grad_group_csum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">cumsum</span><span class="p">(</span><span class="n">grad_group</span><span class="p">[</span><span class="o">~</span><span class="n">null_group</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">204</span>        <span class="n">hess_group_csum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">cumsum</span><span class="p">(</span><span class="n">hess_group</span><span class="p">[</span><span class="o">~</span><span class="n">null_group</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">205</span>        <span class="n">weight_group_csum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">cumsum</span><span class="p">(</span><span class="n">weight_group</span><span class="p">[</span><span class="o">~</span><span class="n">null_group</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">206</span>
<span class="linenos">207</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">208</span>            <span class="k">return</span> <span class="kc">None</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-35">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-35">#</a>
                </div>
                <p>Node total sums</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">209</span>        <span class="n">node_grad_sum</span> <span class="o">=</span> <span class="n">grad_group_csum</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">grad_null_sum</span>
<span class="linenos">210</span>        <span class="n">node_hess_sum</span> <span class="o">=</span> <span class="n">hess_group_csum</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">hess_null_sum</span>
<span class="linenos">211</span>        <span class="n">node_weight_sum</span> <span class="o">=</span> <span class="n">weight_group_csum</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">weight_null_sum</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-36">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-36">#</a>
                </div>
                <p>Calculate split gains for every possible split point and null direction</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">212</span>        <span class="n">grad_group_csum</span> <span class="o">=</span> <span class="n">grad_group_csum</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">213</span>        <span class="n">hess_group_csum</span> <span class="o">=</span> <span class="n">hess_group_csum</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">214</span>        <span class="n">weight_group_csum</span> <span class="o">=</span> <span class="n">weight_group_csum</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">215</span>
<span class="linenos">216</span>        <span class="n">parent_gain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_gain</span><span class="p">(</span><span class="n">node_grad_sum</span><span class="p">,</span> <span class="n">node_hess_sum</span><span class="p">)</span>
<span class="linenos">217</span>        <span class="n">gains_with_nulls_left</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">218</span>            <span class="bp">self</span><span class="o">.</span><span class="n">calculate_gain</span><span class="p">(</span>
<span class="linenos">219</span>                <span class="n">grad_group_csum</span> <span class="o">+</span> <span class="n">grad_null_sum</span><span class="p">,</span>
<span class="linenos">220</span>                <span class="n">hess_group_csum</span> <span class="o">+</span> <span class="n">hess_null_sum</span><span class="p">,</span>
<span class="linenos">221</span>            <span class="p">)</span>
<span class="linenos">222</span>            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_gain</span><span class="p">(</span>
<span class="linenos">223</span>                <span class="n">node_grad_sum</span> <span class="o">-</span> <span class="p">(</span><span class="n">grad_group_csum</span> <span class="o">+</span> <span class="n">grad_null_sum</span><span class="p">),</span>
<span class="linenos">224</span>                <span class="n">node_hess_sum</span> <span class="o">-</span> <span class="p">(</span><span class="n">hess_group_csum</span> <span class="o">+</span> <span class="n">hess_null_sum</span><span class="p">),</span>
<span class="linenos">225</span>            <span class="p">)</span>
<span class="linenos">226</span>            <span class="o">-</span> <span class="n">parent_gain</span>
<span class="linenos">227</span>        <span class="p">)</span>
<span class="linenos">228</span>        <span class="n">gains_with_nulls_right</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">229</span>            <span class="bp">self</span><span class="o">.</span><span class="n">calculate_gain</span><span class="p">(</span>
<span class="linenos">230</span>                <span class="n">grad_group_csum</span><span class="p">,</span>
<span class="linenos">231</span>                <span class="n">hess_group_csum</span><span class="p">,</span>
<span class="linenos">232</span>            <span class="p">)</span>
<span class="linenos">233</span>            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_gain</span><span class="p">(</span>
<span class="linenos">234</span>                <span class="n">node_grad_sum</span> <span class="o">-</span> <span class="n">grad_group_csum</span><span class="p">,</span>
<span class="linenos">235</span>                <span class="n">node_hess_sum</span> <span class="o">-</span> <span class="n">hess_group_csum</span><span class="p">,</span>
<span class="linenos">236</span>            <span class="p">)</span>
<span class="linenos">237</span>            <span class="o">-</span> <span class="n">parent_gain</span>
<span class="linenos">238</span>        <span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-37">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-37">#</a>
                </div>
                <p>Determine the best split for this feature</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">239</span>        <span class="n">split_gain_combined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">concatenate</span><span class="p">(</span>
<span class="linenos">240</span>            <span class="p">[</span><span class="n">gains_with_nulls_left</span><span class="p">,</span> <span class="n">gains_with_nulls_right</span><span class="p">]</span>
<span class="linenos">241</span>        <span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-38">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-38">#</a>
                </div>
                <p>Enforce minimum weight per leaf constraint</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">242</span>        <span class="n">valid_null_left</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">243</span>            <span class="n">weight_group_csum</span> <span class="o">+</span> <span class="n">weight_null_sum</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_weight_leaf</span>
<span class="linenos">244</span>        <span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
<span class="linenos">245</span>            <span class="n">node_weight_sum</span> <span class="o">-</span> <span class="p">(</span><span class="n">weight_group_csum</span> <span class="o">+</span> <span class="n">weight_null_sum</span><span class="p">)</span>
<span class="linenos">246</span>            <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_weight_leaf</span>
<span class="linenos">247</span>        <span class="p">)</span>
<span class="linenos">248</span>        <span class="n">valid_null_right</span> <span class="o">=</span> <span class="p">(</span><span class="n">weight_group_csum</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_weight_leaf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
<span class="linenos">249</span>            <span class="n">node_weight_sum</span> <span class="o">-</span> <span class="n">weight_group_csum</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_weight_leaf</span>
<span class="linenos">250</span>        <span class="p">)</span>
<span class="linenos">251</span>        <span class="n">split_gain_combined</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="kp">concatenate</span><span class="p">([</span><span class="n">valid_null_left</span><span class="p">,</span> <span class="n">valid_null_right</span><span class="p">])]</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">252</span>            <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="kp">inf</span>
<span class="linenos">253</span>        <span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-39">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-39">#</a>
                </div>
                <p>Find the overall best split and store the details in a SplitCandidate object</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">254</span>        <span class="n">best_gain_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">argmax</span><span class="p">(</span><span class="n">split_gain_combined</span><span class="p">)</span>
<span class="linenos">255</span>        <span class="n">feature_gain</span> <span class="o">=</span> <span class="n">split_gain_combined</span><span class="p">[</span><span class="n">best_gain_idx</span><span class="p">]</span>
<span class="linenos">256</span>
<span class="linenos">257</span>        <span class="n">nulls_to_left</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">best_gain_idx</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span>
<span class="linenos">258</span>        <span class="n">split_idx</span> <span class="o">=</span> <span class="n">best_gain_idx</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">259</span>
<span class="linenos">260</span>        <span class="n">left_grad_sum</span> <span class="o">=</span> <span class="n">grad_group_csum</span><span class="p">[</span><span class="n">split_idx</span><span class="p">]</span>
<span class="linenos">261</span>        <span class="n">left_hess_sum</span> <span class="o">=</span> <span class="n">hess_group_csum</span><span class="p">[</span><span class="n">split_idx</span><span class="p">]</span>
<span class="linenos">262</span>        <span class="k">if</span> <span class="n">nulls_to_left</span><span class="p">:</span>
<span class="linenos">263</span>            <span class="n">left_grad_sum</span> <span class="o">+=</span> <span class="n">grad_null_sum</span>
<span class="linenos">264</span>            <span class="n">left_hess_sum</span> <span class="o">+=</span> <span class="n">hess_null_sum</span>
<span class="linenos">265</span>
<span class="linenos">266</span>        <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">"categorical"</span><span class="p">:</span>
<span class="linenos">267</span>            <span class="n">split_point</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">268</span>                <span class="n">groups</span><span class="p">[:</span> <span class="n">split_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
<span class="linenos">269</span>                <span class="n">groups</span><span class="p">[</span><span class="n">split_idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:],</span>
<span class="linenos">270</span>            <span class="p">)</span>
<span class="linenos">271</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">272</span>            <span class="n">split_point</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="n">split_idx</span><span class="p">]</span>
<span class="linenos">273</span>
<span class="linenos">274</span>        <span class="k">return</span> <span class="n">SplitCandidate</span><span class="p">(</span>
<span class="linenos">275</span>            <span class="n">gain</span><span class="o">=</span><span class="n">feature_gain</span><span class="p">,</span>
<span class="linenos">276</span>            <span class="n">feature</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<span class="linenos">277</span>            <span class="n">feature_index</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
<span class="linenos">278</span>            <span class="n">split_point</span><span class="o">=</span><span class="n">split_point</span><span class="p">,</span>
<span class="linenos">279</span>            <span class="n">nulls_to_left</span><span class="o">=</span><span class="n">nulls_to_left</span><span class="p">,</span>
<span class="linenos">280</span>            <span class="n">gradient_sum</span><span class="o">=</span><span class="n">node_grad_sum</span><span class="p">,</span>
<span class="linenos">281</span>            <span class="n">hessian_sum</span><span class="o">=</span><span class="n">node_hess_sum</span><span class="p">,</span>
<span class="linenos">282</span>            <span class="n">left_grad_sum</span><span class="o">=</span><span class="n">left_grad_sum</span><span class="p">,</span>
<span class="linenos">283</span>            <span class="n">left_hess_sum</span><span class="o">=</span><span class="n">left_hess_sum</span><span class="p">,</span>
<span class="linenos">284</span>        <span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-40">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-40">#</a>
                </div>
                <p>Split the given node using the provided split information. Creates left and right child nodes and
updates the parent node accordingly.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">285</span>    <span class="k">def</span><span class="w"> </span><span class="nf">split_node</span><span class="p">(</span>
<span class="linenos">286</span>        <span class="bp">self</span><span class="p">,</span>
<span class="linenos">287</span>        <span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span>
<span class="linenos">288</span>        <span class="n">inputs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span>
<span class="linenos">289</span>        <span class="n">features_info</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s2">"FeatureInfo"</span><span class="p">],</span>
<span class="linenos">290</span>        <span class="n">split_info</span><span class="p">:</span> <span class="n">SplitCandidate</span><span class="p">,</span>
<span class="linenos">291</span>    <span class="p">):</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-41">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-41">#</a>
                </div>
                <p>Update the split criteria for the parent node</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">292</span>        <span class="n">node</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
<span class="linenos">293</span>            <span class="n">feature</span><span class="o">=</span><span class="n">split_info</span><span class="o">.</span><span class="n">feature</span><span class="p">,</span>
<span class="linenos">294</span>            <span class="n">feature_index</span><span class="o">=</span><span class="n">split_info</span><span class="o">.</span><span class="n">feature_index</span><span class="p">,</span>
<span class="linenos">295</span>            <span class="n">split_point</span><span class="o">=</span><span class="n">split_info</span><span class="o">.</span><span class="n">split_point</span><span class="p">,</span>
<span class="linenos">296</span>            <span class="n">nulls_to_left</span><span class="o">=</span><span class="n">split_info</span><span class="o">.</span><span class="n">nulls_to_left</span><span class="p">,</span>
<span class="linenos">297</span>            <span class="n">gradient_sum</span><span class="o">=</span><span class="n">split_info</span><span class="o">.</span><span class="n">gradient_sum</span><span class="p">,</span>
<span class="linenos">298</span>            <span class="n">hessian_sum</span><span class="o">=</span><span class="n">split_info</span><span class="o">.</span><span class="n">hessian_sum</span><span class="p">,</span>
<span class="linenos">299</span>        <span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-42">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-42">#</a>
                </div>
                <p>Determine the feature index in the subsampled dataset</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">300</span>        <span class="n">feature_index</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
<span class="linenos">301</span>            <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">features_info</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">split_info</span><span class="o">.</span><span class="n">feature</span>
<span class="linenos">302</span>        <span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-43">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-43">#</a>
                </div>
                <p>Find out which samples go to the left and right child nodes. This information is used later
for further splits.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">303</span>        <span class="n">mask</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">criterion</span><span class="p">(</span>
<span class="linenos">304</span>            <span class="n">inputs</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">sample_indices</span><span class="p">,</span> <span class="n">feature_index</span><span class="p">],</span> <span class="n">input_type</span><span class="o">=</span><span class="s2">"feature"</span>
<span class="linenos">305</span>        <span class="p">)</span>
<span class="linenos">306</span>        <span class="n">left_child</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span>
<span class="linenos">307</span>            <span class="n">parent</span><span class="o">=</span><span class="n">node</span><span class="p">,</span>
<span class="linenos">308</span>            <span class="n">depth</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">309</span>            <span class="n">l2_regularization</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">l2_regularization</span><span class="p">,</span>
<span class="linenos">310</span>            <span class="n">sample_indices</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">sample_indices</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span>
<span class="linenos">311</span>            <span class="n">gradient_sum</span><span class="o">=</span><span class="n">split_info</span><span class="o">.</span><span class="n">left_grad_sum</span><span class="p">,</span>
<span class="linenos">312</span>            <span class="n">hessian_sum</span><span class="o">=</span><span class="n">split_info</span><span class="o">.</span><span class="n">left_hess_sum</span><span class="p">,</span>
<span class="linenos">313</span>        <span class="p">)</span>
<span class="linenos">314</span>        <span class="n">right_child</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span>
<span class="linenos">315</span>            <span class="n">parent</span><span class="o">=</span><span class="n">node</span><span class="p">,</span>
<span class="linenos">316</span>            <span class="n">depth</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">317</span>            <span class="n">l2_regularization</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">l2_regularization</span><span class="p">,</span>
<span class="linenos">318</span>            <span class="n">sample_indices</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">sample_indices</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">],</span>
<span class="linenos">319</span>            <span class="n">gradient_sum</span><span class="o">=</span><span class="n">split_info</span><span class="o">.</span><span class="n">right_grad_sum</span><span class="p">,</span>
<span class="linenos">320</span>            <span class="n">hessian_sum</span><span class="o">=</span><span class="n">split_info</span><span class="o">.</span><span class="n">right_hess_sum</span><span class="p">,</span>
<span class="linenos">321</span>        <span class="p">)</span>
<span class="linenos">322</span>        <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s2">"left"</span><span class="p">]</span> <span class="o">=</span> <span class="n">left_child</span>
<span class="linenos">323</span>        <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s2">"right"</span><span class="p">]</span> <span class="o">=</span> <span class="n">right_child</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-44">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-44">#</a>
                </div>
                <p>Calculate the per-node gain based on gradients and hessians. The gain is calculated as:</p>
<p>$$\text{gain} = \frac{(T(G))^2}{H + \lambda}$$</p>
<p>where:</p>
<ul>
<li>\(T(G) = \text{sign}(G) \cdot \max(0, |G| - \alpha)\) is the soft-thresholding operator</li>
<li>\(G\) is the sum of gradients</li>
<li>\(H\) is the sum of hessians</li>
<li>\(\alpha\) is the L1 regularization parameter (induces sparsity)</li>
<li>\(\lambda\) is the L2 regularization parameter (prevents overfitting)</li>
</ul>
<p><strong>Parameters</strong></p>
<ul>
<li><code>gradients</code> : np.ndarray
<ul>
<li>The sum of gradients for the node(s) with shape <code>(n_nodes, n_outputs)</code>.</li>
</ul>
</li>
<li><code>hessians</code> : np.ndarray
<ul>
<li>The sum of hessians for the node(s) with shape <code>(n_nodes, n_outputs)</code>.
<strong>Returns</strong></li>
</ul>
</li>
<li><code>gain_outputs</code> : np.ndarray
<ul>
<li>The calculated gain for each node, shape <code>(n_nodes,)</code>.</li>
</ul>
</li>
</ul>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">324</span>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_gain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gradients</span><span class="p">,</span> <span class="n">hessians</span><span class="p">):</span>
<span class="linenos">325</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1_regularization</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">326</span>            <span class="n">gradients</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">sign</span><span class="p">(</span><span class="n">gradients</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="kp">maximum</span><span class="p">(</span>
<span class="linenos">327</span>                <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="kp">abs</span><span class="p">(</span><span class="n">gradients</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1_regularization</span>
<span class="linenos">328</span>            <span class="p">)</span>
<span class="linenos">329</span>        <span class="n">gain_outputs</span> <span class="o">=</span> <span class="p">(</span><span class="n">gradients</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">hessians</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2_regularization</span> <span class="o">+</span> <span class="mf">1e-16</span><span class="p">)</span>
<span class="linenos">330</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective_weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">331</span>            <span class="n">gain_outputs</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective_weight</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="kp">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objective_weight</span><span class="p">)</span>
<span class="linenos">332</span>        <span class="k">return</span> <span class="n">gain_outputs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-45">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-45">#</a>
                </div>
                <p>Subsample features and samples based on the specified fractions. This is useful for
creating a variety of trees in the ensemble and preventing overfitting.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">333</span>    <span class="k">def</span><span class="w"> </span><span class="nf">subsample_dataset</span><span class="p">(</span>
<span class="linenos">334</span>        <span class="bp">self</span><span class="p">,</span>
<span class="linenos">335</span>        <span class="n">inputs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span>
<span class="linenos">336</span>        <span class="n">features_info</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s2">"FeatureInfo"</span><span class="p">],</span>
<span class="linenos">337</span>        <span class="n">targets</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span>
<span class="linenos">338</span>        <span class="n">sample_weight</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span>
<span class="linenos">339</span>        <span class="n">current_predictions</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span>
<span class="linenos">340</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">]:</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-46">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-46">#</a>
                </div>
                <p>Take a random subset of features if specified</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">341</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_fraction</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">342</span>            <span class="n">n_features</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">343</span>            <span class="n">n_subsample_features</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_features</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_fraction</span><span class="p">)</span>
<span class="linenos">344</span>            <span class="n">feature_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
<span class="linenos">345</span>                <span class="n">n_features</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_subsample_features</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span>
<span class="linenos">346</span>            <span class="p">)</span>
<span class="linenos">347</span>            <span class="n">inputs</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[:,</span> <span class="n">feature_indices</span><span class="p">]</span>
<span class="linenos">348</span>            <span class="n">features_info</span> <span class="o">=</span> <span class="p">[</span><span class="n">features_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">feature_indices</span><span class="p">]</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-47">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-47">#</a>
                </div>
                <p>Subsample data points if specified</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">349</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">samples_fraction</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">350</span>            <span class="n">n_samples</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">351</span>            <span class="n">subsample_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_samples</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">samples_fraction</span><span class="p">)</span>
<span class="linenos">352</span>            <span class="n">subsample_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
<span class="linenos">353</span>                <span class="n">n_samples</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">subsample_size</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span>
<span class="linenos">354</span>            <span class="p">)</span>
<span class="linenos">355</span>            <span class="n">inputs</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="n">subsample_indices</span><span class="p">]</span>
<span class="linenos">356</span>            <span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="n">subsample_indices</span><span class="p">]</span>
<span class="linenos">357</span>            <span class="k">if</span> <span class="n">sample_weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">358</span>                <span class="n">sample_weight</span> <span class="o">=</span> <span class="n">sample_weight</span><span class="p">[</span><span class="n">subsample_indices</span><span class="p">]</span>
<span class="linenos">359</span>            <span class="n">current_predictions</span> <span class="o">=</span> <span class="n">current_predictions</span><span class="p">[</span><span class="n">subsample_indices</span><span class="p">]</span>
<span class="linenos">360</span>
<span class="linenos">361</span>        <span class="k">return</span> <span class="p">(</span>
<span class="linenos">362</span>            <span class="n">inputs</span><span class="p">,</span>
<span class="linenos">363</span>            <span class="n">features_info</span><span class="p">,</span>
<span class="linenos">364</span>            <span class="n">targets</span><span class="p">,</span>
<span class="linenos">365</span>            <span class="n">sample_weight</span><span class="p">,</span>
<span class="linenos">366</span>            <span class="n">current_predictions</span><span class="p">,</span>
<span class="linenos">367</span>        <span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-48">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-48">#</a>
                </div>
                <p>Apply Gradient-based One-Side Sampling. The idea is to retain instances with large gradients
while randomly sampling from instances with small gradients. This helps focus the model
on hard-to-predict instances while still maintaining a representative sample of the overall data.</p>
<p><strong>Input:</strong> \(g\) (gradients), \(h\) (hessians), \(X\) (inputs), \(y\) (targets),
\(w\) (sample weights), \(a\) (top rate), \(b\) (bottom rate), \(\text{rescale}\) (rescale-bottom flag)</p>
<p>$$
\begin{aligned}
&amp; n = |g|,\ n_{\text{top}} = \lfloor a n \rfloor,\ n_{\text{bot}} = \lfloor b n \rfloor \\
&amp; r_i = \lVert g_i \rVert_1,\ \pi = \operatorname{argsort}(r;\ \text{descending}) \\
&amp; T = \{\pi_1,\dots,\pi_{n_{\text{top}}}\},\ C = \{\pi_{n_{\text{top}}+1},\dots,\pi_n\} \\
&amp; B \sim \text{UniformSubset}(C,\ n_{\text{bot}}),\ S = T \cup B \\
&amp; \text{if rescale:} \\
&amp;\quad s = \frac{\sum_{i \notin T} w_i}{\sum_{i \in B} w_i},\
\forall i \in B:\ (g_i,h_i,w_i) \leftarrow s (g_i,h_i,w_i)
\end{aligned}
$$</p>
<p><strong>Output:</strong> \( \{(x_i,y_i,g_i,h_i,w_i)\}_{i \in S} \)</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">368</span>    <span class="k">def</span><span class="w"> </span><span class="nf">apply_goss_sampling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gradient</span><span class="p">,</span> <span class="n">hessian</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">sample_weight</span><span class="p">):</span>
<span class="linenos">369</span>        <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gradient</span><span class="p">)</span>
<span class="linenos">370</span>        <span class="n">n_top</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_samples</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">goss_top_rate</span><span class="p">)</span>
<span class="linenos">371</span>        <span class="n">n_bottom</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_samples</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">goss_bottom_rate</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-49">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-49">#</a>
                </div>
                <p>Sort the samples by absolute gradient values in descending order</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">372</span>        <span class="n">abs_grad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">abs</span><span class="p">(</span><span class="n">gradient</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">373</span>        <span class="n">sorted_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">abs_grad</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-50">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-50">#</a>
                </div>
                <p>Select top and bottom samples</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">374</span>        <span class="n">top_indices</span> <span class="o">=</span> <span class="n">sorted_indices</span><span class="p">[:</span><span class="n">n_top</span><span class="p">]</span>
<span class="linenos">375</span>        <span class="n">bottom_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
<span class="linenos">376</span>            <span class="n">sorted_indices</span><span class="p">[</span><span class="n">n_top</span><span class="p">:],</span> <span class="n">n_bottom</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span>
<span class="linenos">377</span>        <span class="p">)</span>
<span class="linenos">378</span>        <span class="n">selected_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">concatenate</span><span class="p">([</span><span class="n">top_indices</span><span class="p">,</span> <span class="n">bottom_indices</span><span class="p">])</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="grower-51">
            <div class="docs">
                <div class="section-link">
                    <a href="#grower-51">#</a>
                </div>
                <p>I added an argument to make it optional whether to rescale the bottom instances or not. I found
that in some cases, not rescaling gives better results.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">379</span>        <span class="n">scale</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="linenos">380</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">goss_rescale_bottom</span><span class="p">:</span>
<span class="linenos">381</span>            <span class="n">scale</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">382</span>                <span class="n">np</span><span class="o">.</span><span class="kp">sum</span><span class="p">(</span><span class="n">sample_weight</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="kp">sum</span><span class="p">(</span><span class="n">sample_weight</span><span class="p">[</span><span class="n">top_indices</span><span class="p">])</span>
<span class="linenos">383</span>            <span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="kp">sum</span><span class="p">(</span><span class="n">sample_weight</span><span class="p">[</span><span class="n">bottom_indices</span><span class="p">])</span>
<span class="linenos">384</span>
<span class="linenos">385</span>        <span class="n">gradient</span> <span class="o">=</span> <span class="n">gradient</span><span class="p">[</span><span class="n">selected_indices</span><span class="p">]</span>
<span class="linenos">386</span>        <span class="n">hessian</span> <span class="o">=</span> <span class="n">hessian</span><span class="p">[</span><span class="n">selected_indices</span><span class="p">]</span>
<span class="linenos">387</span>        <span class="n">sample_weight</span> <span class="o">=</span> <span class="n">sample_weight</span><span class="p">[</span><span class="n">selected_indices</span><span class="p">]</span>
<span class="linenos">388</span>
<span class="linenos">389</span>        <span class="n">gradient</span><span class="p">[</span><span class="n">n_top</span><span class="p">:]</span> <span class="o">*=</span> <span class="n">scale</span>
<span class="linenos">390</span>        <span class="n">hessian</span><span class="p">[</span><span class="n">n_top</span><span class="p">:]</span> <span class="o">*=</span> <span class="n">scale</span>
<span class="linenos">391</span>        <span class="n">sample_weight</span><span class="p">[</span><span class="n">n_top</span><span class="p">:]</span> <span class="o">*=</span> <span class="n">scale</span>
<span class="linenos">392</span>
<span class="linenos">393</span>        <span class="k">return</span> <span class="p">(</span>
<span class="linenos">394</span>            <span class="n">gradient</span><span class="p">,</span>
<span class="linenos">395</span>            <span class="n">hessian</span><span class="p">,</span>
<span class="linenos">396</span>            <span class="n">inputs</span><span class="p">[</span><span class="n">selected_indices</span><span class="p">],</span>
<span class="linenos">397</span>            <span class="n">targets</span><span class="p">[</span><span class="n">selected_indices</span><span class="p">],</span>
<span class="linenos">398</span>            <span class="n">sample_weight</span><span class="p">,</span>
<span class="linenos">399</span>        <span class="p">)</span></pre></div>

            </div>
        </div>
    
        </div>
    
</div>
</div>
</section>
<section id="loss-functions-and-distributions" class="level2 page-columns page-full" data-number="4.5">
<h2 data-number="4.5" data-anchor-id="loss-functions-and-distributions"><span class="header-section-number">4.5</span> Loss Functions and Distributions</h2>
<p>This part took a while to get right, but I had a lot of inspiration from <a href="https://github.com/CDonnerer/xgboost-distribution">xgboost-distribution</a>, <a href="https://docs.pytorch.org/docs/stable/distributions.html">torch.distributions</a> which helped in the design.</p>
<p>Here, I take the probabilistic approach by using Maximum Likelihood Estimation (MLE) to <em>introduce</em> the two loss functions (Squared and BCE) that I implemented here, but in reality as long as you can compute the gradients and hessians for a given loss function, you can plug it in. The reason I like the probabilistic approach is that it opens the door to more advanced use-cases such as uncertainty estimation (variance parameter), and also gives an intuitive understanding behind the loss functions we use but rarely question.</p>
<div id="0c0e6d5e" class="cell no-style-output page-columns page-full" data-execution_count="6">
<div class="cell-output cell-output-display column-page">
<h3 style="margin-top: 0;">distributions.py</h3>
        <div class="docfuse ">
            
        <div class="section" id="distributions-0">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-0">#</a>
                </div>
                
            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">1</span><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="linenos">2</span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tuple</span>
<span class="linenos">3</span>
<span class="linenos">4</span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="linenos">5</span>
<span class="linenos">6</span><span class="kn">from</span><span class="w"> </span><span class="nn">.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">sigmoid</span><span class="p">,</span> <span class="n">to_2d</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-1">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-1">#</a>
                </div>
                <p>Base class for loss distributions.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">7</span><span class="k">class</span><span class="w"> </span><span class="nc">Distribution</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-2">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-2">#</a>
                </div>
                <p>Number of parameters/output dimensions required by the distribution.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos"> 8</span>    <span class="nd">@property</span>
<span class="linenos"> 9</span>    <span class="nd">@abstractmethod</span>
<span class="linenos">10</span>    <span class="k">def</span><span class="w"> </span><span class="nf">n_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-3">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-3">#</a>
                </div>
                <p>Compute the log probability of the true values given the predictions.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">11</span>    <span class="nd">@abstractmethod</span>
<span class="linenos">12</span>    <span class="k">def</span><span class="w"> </span><span class="nf">log_prob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">:</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-4">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-4">#</a>
                </div>
                <p>Return interpretable predictions (e.g., [mu, sigma] for Gaussian, [prob] for Bernoulli).</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">13</span>    <span class="nd">@abstractmethod</span>
<span class="linenos">14</span>    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">:</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-5">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-5">#</a>
                </div>
                <p>Compute the gradient and hessian of the loss function w.r.t. predictions.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">15</span>    <span class="nd">@abstractmethod</span>
<span class="linenos">16</span>    <span class="k">def</span><span class="w"> </span><span class="nf">gradient_hessian</span><span class="p">(</span>
<span class="linenos">17</span>        <span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span> <span class="n">weight</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">18</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">]:</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-6">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-6">#</a>
                </div>
                <p>Initialize the parameters based on the target values.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">19</span>    <span class="nd">@abstractmethod</span>
<span class="linenos">20</span>    <span class="k">def</span><span class="w"> </span><span class="nf">init_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">:</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-7">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-7">#</a>
                </div>
                <p>Generate samples from the distribution given predictions.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">21</span>    <span class="nd">@abstractmethod</span>
<span class="linenos">22</span>    <span class="k">def</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span>
<span class="linenos">23</span>        <span class="bp">self</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">random_state</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span>
<span class="linenos">24</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">:</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-8">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-8">#</a>
                </div>
                <p>Gaussian distribution objective for regression tasks. Uses natural
parameterization for faster convergence.</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>learn_variance</code> : bool, default=False
<ul>
<li>Whether to learn the variance parameter or assume it is fixed.
If False: equivalent to Squared loss (homoscedastic regression).
If True: models both mean and variance (heteroscedastic regression).</li>
</ul>
</li>
</ul>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">25</span><span class="k">class</span><span class="w"> </span><span class="nc">Gaussian</span><span class="p">(</span><span class="n">Distribution</span><span class="p">):</span>
<span class="linenos">26</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">learn_variance</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="linenos">27</span>        <span class="bp">self</span><span class="o">.</span><span class="n">learn_variance</span> <span class="o">=</span> <span class="n">learn_variance</span>
<span class="linenos">28</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">learn_variance</span><span class="p">:</span>
<span class="linenos">29</span>            <span class="bp">self</span><span class="o">.</span><span class="n">eta2_fixed</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-9">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-9">#</a>
                </div>
                
            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">30</span>    <span class="nd">@property</span>
<span class="linenos">31</span>    <span class="k">def</span><span class="w"> </span><span class="nf">n_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="linenos">32</span>        <span class="k">return</span> <span class="mi">2</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn_variance</span> <span class="k">else</span> <span class="mi">1</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-10">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-10">#</a>
                </div>
                <p>Log probability of Gaussian distribution. Meaning, for each data point, we calculate
\(\log P(y_{\text{true}} \mid \theta)\) where \(\theta\) are the parameters predicted by the model. During learning,
we find the optimal \(\theta\) that maximizes this log probability over the training set.</p>
<p>This implementation uses the natural parameterization of the Gaussian distribution, where
the learnable parameters are:</p>
<p>$$\begin{aligned}
\eta_1 &amp;= \frac{\mu}{\sigma^2} \\
\eta_2 &amp;= -\frac{1}{2\sigma^2}
\end{aligned}$$</p>
<p>In practice, we don't learn \(\eta_2\) directly, since it must be negative, but the model output
is unbounded. Instead, we model \(z\) where \(\eta_2 = -\exp(z)\). This ensures \(\eta_2\) is always negative, since
\(\exp(z) &gt; 0\) for all real \(z\).</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">33</span>    <span class="k">def</span><span class="w"> </span><span class="nf">log_prob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">:</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-11">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-11">#</a>
                </div>
                <p>Convert the raw predictions (\(\eta_1, z\)) to (\(\mu, \sigma\))</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">34</span>        <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_prediction</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">T</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-12">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-12">#</a>
                </div>
                <p>Compute log probability using the standard Gaussian formula</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">35</span>        <span class="n">log_prob</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">36</span>            <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="kp">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
<span class="linenos">37</span>            <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="kp">log</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
<span class="linenos">38</span>            <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">((</span><span class="n">y_true</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos">39</span>        <span class="p">)</span>
<span class="linenos">40</span>        <span class="k">return</span> <span class="n">log_prob</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-13">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-13">#</a>
                </div>
                <p>Return predictions \((\mu, \sigma)\).
Output Shape: <code>(n_samples, 1 or 2)</code> depending on whether variance is learnable.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">41</span>    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">:</span>
<span class="linenos">42</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_prediction</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)[:,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_outputs</span><span class="p">]</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-14">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-14">#</a>
                </div>
                <p>Compute the gradient and hessian of the negative log likelihood loss
w.r.t. the natural parameters \((\eta_1, \eta_2)\).</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">43</span>    <span class="k">def</span><span class="w"> </span><span class="nf">gradient_hessian</span><span class="p">(</span>
<span class="linenos">44</span>        <span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span> <span class="n">weight</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">45</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">]:</span>
<span class="linenos">46</span>        <span class="n">eta1</span><span class="p">,</span> <span class="n">eta2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_prediction</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">natural</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="linenos">47</span>
<span class="linenos">48</span>        <span class="n">grad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">zeros_like</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
<span class="linenos">49</span>        <span class="n">hess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">zeros_like</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-15">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-15">#</a>
                </div>
                <p>Derivatives w.r.t. \(\eta_1\)</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">50</span>        <span class="n">grad</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">y_true</span> <span class="o">-</span> <span class="n">eta1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">eta2</span><span class="p">)</span>
<span class="linenos">51</span>        <span class="n">hess</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">eta2</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-16">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-16">#</a>
                </div>
                <p>If learning variance, then \(z\) is also a learnable parameter</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">52</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn_variance</span><span class="p">:</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-17">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-17">#</a>
                </div>
                <p>Derivatives w.r.t. \(\eta_2\)</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">53</span>            <span class="n">grad_eta2</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">y_true</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">eta1</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">eta2</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">eta2</span><span class="p">)</span>
<span class="linenos">54</span>            <span class="n">hess_eta2</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">eta1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">eta2</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">eta2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-18">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-18">#</a>
                </div>
                <p>Derivatives w.r.t \(z\), which is the raw output of the model
Chain rule: \(\frac{dL}{dz} = \frac{dL}{d\eta_2} \cdot \frac{d\eta_2}{dz}\)
where \(\frac{d\eta_2}{dz} = -\exp(z) = \eta_2\)</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">55</span>            <span class="n">grad</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">grad_eta2</span> <span class="o">*</span> <span class="n">eta2</span>
<span class="linenos">56</span>            <span class="n">hess</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">hess_eta2</span> <span class="o">*</span> <span class="p">(</span><span class="n">eta2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">grad_eta2</span> <span class="o">*</span> <span class="n">eta2</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-19">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-19">#</a>
                </div>
                
            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">57</span>        <span class="k">if</span> <span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">58</span>            <span class="n">weight</span> <span class="o">=</span> <span class="n">to_2d</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
<span class="linenos">59</span>            <span class="n">grad</span> <span class="o">*=</span> <span class="n">weight</span>
<span class="linenos">60</span>            <span class="n">hess</span> <span class="o">*=</span> <span class="n">weight</span>
<span class="linenos">61</span>
<span class="linenos">62</span>        <span class="k">return</span> <span class="n">grad</span><span class="p">,</span> <span class="n">hess</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-20">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-20">#</a>
                </div>
                <p>Returns initial \((\eta_1, \eta_2)\) or \((\eta_1)\) if variance is fixed.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">63</span>    <span class="k">def</span><span class="w"> </span><span class="nf">init_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="linenos">64</span>        <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">mean</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="linenos">65</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn_variance</span><span class="p">:</span>
<span class="linenos">66</span>            <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">std</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="linenos">67</span>            <span class="n">eta1</span><span class="p">,</span> <span class="n">eta2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_natural</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
<span class="linenos">68</span>            <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">log</span><span class="p">(</span><span class="o">-</span><span class="n">eta2</span><span class="p">)</span>  <span class="c1"># Inverse of eta2 = -exp(z)</span>
<span class="linenos">69</span>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="kp">array</span><span class="p">([</span><span class="n">eta1</span><span class="p">,</span> <span class="n">z</span><span class="p">])</span>
<span class="linenos">70</span>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="kp">array</span><span class="p">([</span><span class="n">mu</span><span class="p">])</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-21">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-21">#</a>
                </div>
                <p>Mean is \(\mu\) parameter of the Gaussian.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">71</span>    <span class="k">def</span><span class="w"> </span><span class="nf">mean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">:</span>
<span class="linenos">72</span>        <span class="n">mu</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_prediction</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="linenos">73</span>        <span class="k">return</span> <span class="n">mu</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-22">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-22">#</a>
                </div>
                <p>Standard deviation is \(\sigma\) parameter of the Gaussian.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">74</span>    <span class="k">def</span><span class="w"> </span><span class="nf">stdev</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">:</span>
<span class="linenos">75</span>        <span class="n">_</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_prediction</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="linenos">76</span>        <span class="k">return</span> <span class="n">sigma</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-23">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-23">#</a>
                </div>
                <p>Generate samples from the Gaussian distribution given predictions.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">77</span>    <span class="k">def</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span>
<span class="linenos">78</span>        <span class="bp">self</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">random_state</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span>
<span class="linenos">79</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">:</span>
<span class="linenos">80</span>        <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_prediction</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="linenos">81</span>        <span class="k">return</span> <span class="n">random_state</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">mu</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_samples</span><span class="p">))</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-24">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-24">#</a>
                </div>
                <p>Compute the entropy of the Gaussian distribution given predictions.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">82</span>    <span class="k">def</span><span class="w"> </span><span class="nf">entropy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">:</span>
<span class="linenos">83</span>        <span class="n">_</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_prediction</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="linenos">84</span>        <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="kp">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">e</span> <span class="o">*</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-25">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-25">#</a>
                </div>
                <p>Convert raw predictions to \((\mu, \sigma)\) or \((\eta_1, \eta_2)\).</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">85</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_format_prediction</span><span class="p">(</span>
<span class="linenos">86</span>        <span class="bp">self</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span> <span class="n">natural</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">87</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">:</span>
<span class="linenos">88</span>        <span class="n">eta1</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="linenos">89</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn_variance</span><span class="p">:</span>
<span class="linenos">90</span>            <span class="n">z</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-26">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-26">#</a>
                </div>
                <p>model \(z\) instead of \(\eta_2\) directly to ensure negativity</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">91</span>            <span class="n">eta2</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="kp">exp</span><span class="p">(</span><span class="n">z</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-27">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-27">#</a>
                </div>
                
            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">92</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">93</span>            <span class="n">eta2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">eta1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta2_fixed</span><span class="p">)</span>
<span class="linenos">94</span>
<span class="linenos">95</span>        <span class="k">if</span> <span class="n">natural</span><span class="p">:</span>
<span class="linenos">96</span>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="kp">column_stack</span><span class="p">([</span><span class="n">eta1</span><span class="p">,</span> <span class="n">eta2</span><span class="p">])</span>
<span class="linenos">97</span>        <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_natural</span><span class="p">(</span><span class="n">eta1</span><span class="p">,</span> <span class="n">eta2</span><span class="p">)</span>
<span class="linenos">98</span>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="kp">column_stack</span><span class="p">([</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">])</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-28">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-28">#</a>
                </div>
                <p>Helper function to convert \((\mu, \sigma)\) to \((\eta_1, \eta_2)\).</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos"> 99</span>    <span class="nd">@staticmethod</span>
<span class="linenos">100</span>    <span class="k">def</span><span class="w"> </span><span class="nf">to_natural</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
<span class="linenos">101</span>        <span class="n">eta1</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">/</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span>
<span class="linenos">102</span>        <span class="n">eta2</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos">103</span>        <span class="k">return</span> <span class="n">eta1</span><span class="p">,</span> <span class="n">eta2</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-29">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-29">#</a>
                </div>
                <p>Helper function to convert \((\eta_1, \eta_2)\) to \((\mu, \sigma)\).</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">104</span>    <span class="nd">@staticmethod</span>
<span class="linenos">105</span>    <span class="k">def</span><span class="w"> </span><span class="nf">from_natural</span><span class="p">(</span><span class="n">eta1</span><span class="p">,</span> <span class="n">eta2</span><span class="p">):</span>
<span class="linenos">106</span>        <span class="n">mu</span> <span class="o">=</span> <span class="o">-</span><span class="n">eta1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">eta2</span><span class="p">)</span>
<span class="linenos">107</span>        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">sqrt</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">eta2</span><span class="p">))</span>
<span class="linenos">108</span>        <span class="k">return</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-30">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-30">#</a>
                </div>
                <p>Logistic objective for binary classification tasks.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">109</span><span class="k">class</span><span class="w"> </span><span class="nc">Bernoulli</span><span class="p">(</span><span class="n">Distribution</span><span class="p">):</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-31">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-31">#</a>
                </div>
                
            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">110</span>    <span class="nd">@property</span>
<span class="linenos">111</span>    <span class="k">def</span><span class="w"> </span><span class="nf">n_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="linenos">112</span>        <span class="k">return</span> <span class="mi">1</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-32">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-32">#</a>
                </div>
                <p>Log probability of Bernoulli distribution.</p>
<p>The Bernoulli distribution is:
$$P(y \mid p) = p^y (1-p)^{1-y}$$</p>
<p>Where \(p\) is the probability of success, and \(y \in \{0, 1\}\). Taking the log, we get:
$$\log P(y \mid p) = y \log p + (1-y) \log(1-p)$$</p>
<p>Which is the standard binary cross-entropy loss.</p>
<p><strong>Logit Parameterization:</strong></p>
<p>We model \(z \in \mathbb{R}\) (logit) instead of \(p\) directly, using the sigmoid transform:
$$p = \sigma(z) = \frac{1}{1 + e^{-z}}$$</p>
<p>The rationale behind this is that since the model outputs are unbounded, using sigmoid
squashes them into the valid probability range (0, 1).</p>
<p>By substituting \(p = \sigma(z)\) into the log probability, we get:
$$\log P(y \mid z) = y \cdot z - \log(1 + e^{z})$$</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">113</span>    <span class="k">def</span><span class="w"> </span><span class="nf">log_prob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">:</span>
<span class="linenos">114</span>        <span class="n">logit</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="linenos">115</span>        <span class="k">return</span> <span class="n">y_true</span> <span class="o">*</span> <span class="n">logit</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">logaddexp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">logit</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-33">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-33">#</a>
                </div>
                <p>Returns the probability \(p\) of the positive class.
Output Shape: <code>(n_samples, 1)</code></p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">116</span>    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">:</span>
<span class="linenos">117</span>        <span class="n">logit</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="linenos">118</span>        <span class="n">prob</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">logit</span><span class="p">)</span>
<span class="linenos">119</span>        <span class="k">return</span> <span class="n">prob</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-34">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-34">#</a>
                </div>
                <p>The derivatives of the loss function (negative log likelihood) w.r.t. the model output
(logit parameter \(z\)) are:</p>
<ul>
<li>Gradient: \(\sigma(\text{z}) - y\)</li>
<li>Hessian: \(\sigma(\text{z}) \cdot (1 - \sigma(\text{z}))\)</li>
</ul>
<p>where \(\sigma\) is the sigmoid function.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">120</span>    <span class="k">def</span><span class="w"> </span><span class="nf">gradient_hessian</span><span class="p">(</span>
<span class="linenos">121</span>        <span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span> <span class="n">weight</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">122</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">]:</span>
<span class="linenos">123</span>        <span class="n">logit</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="linenos">124</span>        <span class="n">prob</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">logit</span><span class="p">)</span>
<span class="linenos">125</span>
<span class="linenos">126</span>        <span class="n">grad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">zeros_like</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
<span class="linenos">127</span>        <span class="n">hess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">zeros_like</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>
<span class="linenos">128</span>
<span class="linenos">129</span>        <span class="n">grad</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob</span> <span class="o">-</span> <span class="n">y_true</span>
<span class="linenos">130</span>        <span class="n">hess</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prob</span><span class="p">)</span>
<span class="linenos">131</span>
<span class="linenos">132</span>        <span class="k">if</span> <span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">133</span>            <span class="n">weight</span> <span class="o">=</span> <span class="n">to_2d</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
<span class="linenos">134</span>            <span class="n">grad</span> <span class="o">*=</span> <span class="n">weight</span>
<span class="linenos">135</span>            <span class="n">hess</span> <span class="o">*=</span> <span class="n">weight</span>
<span class="linenos">136</span>
<span class="linenos">137</span>        <span class="k">return</span> <span class="n">grad</span><span class="p">,</span> <span class="n">hess</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-35">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-35">#</a>
                </div>
                <p>Returns initial logit based on mean probability (a priori).
Note: $$p = \sigma(\text{z}) = \frac{1}{1 + e^{-\text{z}}} \implies \text{z} = \log \frac{p}{1-p}$$</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">138</span>    <span class="k">def</span><span class="w"> </span><span class="nf">init_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="linenos">139</span>        <span class="n">mean_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="kp">mean</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="mf">1e-7</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="mf">1e-7</span><span class="p">)</span>
<span class="linenos">140</span>        <span class="n">logit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">log</span><span class="p">(</span><span class="n">mean_prob</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">mean_prob</span><span class="p">))</span>
<span class="linenos">141</span>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="kp">array</span><span class="p">([</span><span class="n">logit</span><span class="p">])</span>
<span class="linenos">142</span>
<span class="linenos">143</span>    <span class="n">mean</span> <span class="o">=</span> <span class="n">predict</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="distributions-36">
            <div class="docs">
                <div class="section-link">
                    <a href="#distributions-36">#</a>
                </div>
                <p>Generate samples from the Bernoulli distribution given predictions.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">144</span>    <span class="k">def</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span>
<span class="linenos">145</span>        <span class="bp">self</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">random_state</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span>
<span class="linenos">146</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">:</span>
<span class="linenos">147</span>        <span class="n">logit</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="linenos">148</span>        <span class="n">prob</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">logit</span><span class="p">)</span>
<span class="linenos">149</span>        <span class="k">return</span> <span class="n">random_state</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">prob</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prob</span><span class="p">),</span> <span class="n">n_samples</span><span class="p">))</span></pre></div>

            </div>
        </div>
    
        </div>
    
</div>
</div>
</section>
<section id="utility-functions" class="level2 page-columns page-full" data-number="4.6">
<h2 data-number="4.6" data-anchor-id="utility-functions"><span class="header-section-number">4.6</span> Utility Functions</h2>
<p>This module contains a few utility functions that are used throughout the codebase. Nothing fancy here, except for the Numba aggregation function used to speed up histogram construction.</p>
<div id="3bdffa43" class="cell no-style-output page-columns page-full" data-execution_count="7">
<div class="cell-output cell-output-display column-page">
<h3 style="margin-top: 0;">utils.py</h3>
        <div class="docfuse ">
            
        <div class="section" id="utils-0">
            <div class="docs">
                <div class="section-link">
                    <a href="#utils-0">#</a>
                </div>
                
            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">1</span><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="kn">import</span><span class="w"> </span><span class="nn">numba</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nb</span>
<span class="linenos">4</span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="utils-1">
            <div class="docs">
                <div class="section-link">
                    <a href="#utils-1">#</a>
                </div>
                <p>Compute grouped sums of gradients and hessians for 2D arrays. Uses Numba for speedup.
Input Shape: <code>(n_samples, n_outputs)</code>
Output Shape: <code>(n_groups, n_outputs)</code></p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos"> 5</span><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span>
<span class="linenos"> 6</span><span class="k">def</span><span class="w"> </span><span class="nf">groupby_sum_2d</span><span class="p">(</span>
<span class="linenos"> 7</span>    <span class="n">n_groups</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="linenos"> 8</span>    <span class="n">group_indices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span>
<span class="linenos"> 9</span>    <span class="n">gradients</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span>
<span class="linenos">10</span>    <span class="n">hessians</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span>
<span class="linenos">11</span>    <span class="n">sample_weight</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span>
<span class="linenos">12</span><span class="p">):</span>
<span class="linenos">13</span>    <span class="n">n_outputs</span> <span class="o">=</span> <span class="n">gradients</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">14</span>
<span class="linenos">15</span>    <span class="n">grad_sums</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">empty</span><span class="p">((</span><span class="n">n_groups</span><span class="p">,</span> <span class="n">n_outputs</span><span class="p">))</span>
<span class="linenos">16</span>    <span class="n">hess_sums</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">empty</span><span class="p">((</span><span class="n">n_groups</span><span class="p">,</span> <span class="n">n_outputs</span><span class="p">))</span>
<span class="linenos">17</span>    <span class="n">weight_sums</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">bincount</span><span class="p">(</span><span class="n">group_indices</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="n">n_groups</span><span class="p">)</span>
<span class="linenos">18</span>
<span class="linenos">19</span>    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_outputs</span><span class="p">):</span>
<span class="linenos">20</span>        <span class="n">grad_sums</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">bincount</span><span class="p">(</span>
<span class="linenos">21</span>            <span class="n">group_indices</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">gradients</span><span class="p">[:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">minlength</span><span class="o">=</span><span class="n">n_groups</span>
<span class="linenos">22</span>        <span class="p">)</span>
<span class="linenos">23</span>        <span class="n">hess_sums</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">bincount</span><span class="p">(</span>
<span class="linenos">24</span>            <span class="n">group_indices</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">hessians</span><span class="p">[:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">minlength</span><span class="o">=</span><span class="n">n_groups</span>
<span class="linenos">25</span>        <span class="p">)</span>
<span class="linenos">26</span>
<span class="linenos">27</span>    <span class="k">return</span> <span class="n">grad_sums</span><span class="p">,</span> <span class="n">hess_sums</span><span class="p">,</span> <span class="n">weight_sums</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="utils-2">
            <div class="docs">
                <div class="section-link">
                    <a href="#utils-2">#</a>
                </div>
                <p>Map the values in the input array according to the provided mapping dictionary.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">28</span><span class="k">def</span><span class="w"> </span><span class="nf">map_array</span><span class="p">(</span><span class="n">arr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">,</span> <span class="n">mapping</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">missing_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="kp">nan</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">:</span>
<span class="linenos">29</span>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="kp">vectorize</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">missing_value</span><span class="p">))(</span><span class="n">arr</span><span class="p">)</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="utils-3">
            <div class="docs">
                <div class="section-link">
                    <a href="#utils-3">#</a>
                </div>
                <p>Ensure the input array is 2D. If 1D, reshape to (n_samples, 1).</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">30</span><span class="k">def</span><span class="w"> </span><span class="nf">to_2d</span><span class="p">(</span><span class="n">arr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">:</span>
<span class="linenos">31</span>    <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">32</span>        <span class="k">return</span> <span class="n">arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">33</span>    <span class="k">elif</span> <span class="n">arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
<span class="linenos">34</span>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Input array must be 1D or 2D, but got </span><span class="si">{</span><span class="n">arr</span><span class="o">.</span><span class="n">ndim</span><span class="si">}</span><span class="s2">D."</span><span class="p">)</span>
<span class="linenos">35</span>    <span class="k">return</span> <span class="n">arr</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="utils-4">
            <div class="docs">
                <div class="section-link">
                    <a href="#utils-4">#</a>
                </div>
                <p>Compute the sigmoid function for each element in the input array.
$$\sigma(x) = \frac{1}{1 + e^{-x}}$$</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">36</span><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span>
<span class="linenos">37</span><span class="k">def</span><span class="w"> </span><span class="nf">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="kp">ndarray</span><span class="p">:</span>
<span class="linenos">38</span>    <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="kp">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">))</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="utils-5">
            <div class="docs">
                <div class="section-link">
                    <a href="#utils-5">#</a>
                </div>
                <p>Adaptively truncate a number based on a percentage of its magnitude. I use this
pretty much everywhere to make sure numerical outputs don't look ugly.</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">39</span><span class="k">def</span><span class="w"> </span><span class="nf">trunc</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">threshold_percent</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">truncate_integer</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">40</span>    <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">41</span>        <span class="k">return</span> <span class="mi">0</span>
<span class="linenos">42</span>
<span class="linenos">43</span>    <span class="n">sign</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
<span class="linenos">44</span>    <span class="n">num</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
<span class="linenos">45</span>
<span class="linenos">46</span>    <span class="n">min_change</span> <span class="o">=</span> <span class="n">num</span> <span class="o">*</span> <span class="p">(</span><span class="n">threshold_percent</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
<span class="linenos">47</span>    <span class="n">decimal_places</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">min_change</span><span class="p">))</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="utils-6">
            <div class="docs">
                <div class="section-link">
                    <a href="#utils-6">#</a>
                </div>
                <p>Check if we need to lose an additional decimal place</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">48</span>    <span class="n">scale_d</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">decimal_places</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">49</span>    <span class="n">digit_value_to_lose</span> <span class="o">=</span> <span class="p">((</span><span class="n">num</span> <span class="o">*</span> <span class="n">scale_d</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">scale_d</span>
<span class="linenos">50</span>    <span class="k">if</span> <span class="n">min_change</span> <span class="o">&gt;=</span> <span class="n">digit_value_to_lose</span><span class="p">:</span>
<span class="linenos">51</span>        <span class="n">decimal_places</span> <span class="o">-=</span> <span class="mi">1</span></pre></div>

            </div>
        </div>
    

        <div class="section" id="utils-7">
            <div class="docs">
                <div class="section-link">
                    <a href="#utils-7">#</a>
                </div>
                <p>Don't truncate integer digits unless explicitly allowed</p>

            </div>
            <div class="code">
                <div class="highlight"><pre><span class="linenos">52</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">truncate_integer</span><span class="p">:</span>
<span class="linenos">53</span>        <span class="n">decimal_places</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">decimal_places</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">54</span>
<span class="linenos">55</span>    <span class="n">scale</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">decimal_places</span>
<span class="linenos">56</span>    <span class="n">truncated</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span> <span class="o">/</span> <span class="n">scale</span>
<span class="linenos">57</span>    <span class="k">return</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">truncated</span></pre></div>

            </div>
        </div>
    
        </div>
    
</div>
</div>
</section>
</section>
<section id="experiments" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Experiments</h1>
<p>Now that we have the implementation ready, let’s see how it performs on simple regression and classification tasks. We’ll use the Adult Census Income dataset for classification, and the California Housing dataset for regression</p>
<p>Install required packages</p>
<div id="1d8a962d" class="cell" data-execution_count="28">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>pip install numpy pandas numba scikit<span class="op">-</span>learn framedisplay <span class="op">--</span>quiet</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Add <code>src</code> (where the GBT implementation lives) to <code>sys.path</code>, and initialize <a href="https://github.com/nsarang/framedisplay">FrameDisplay</a> for better DataFrame visualization.</p>
<div id="14083474" class="cell" data-execution_count="30">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> framedisplay <span class="im">as</span> fd</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>sys.path.insert(<span class="dv">0</span>, <span class="st">"./src"</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>fd.configure(<span class="bu">dict</span>(theme<span class="op">=</span><span class="st">"ocean"</span>))</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>fd.integrate_with_pandas()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

        <script>
            window.FrameDisplayConfig = Object.assign(window.FrameDisplayConfig || {}, {"theme": "ocean"});
        </script>
    
</div>
</div>
<section id="census-income-dataset" class="level2" data-number="5.1">
<h2 data-number="5.1" data-anchor-id="census-income-dataset"><span class="header-section-number">5.1</span> Census Income Dataset</h2>
<p>This is a binary classification task where the goal is to predict whether an individual’s income exceeds $50K/year based on a number of attributes such as age, education, occupation, etc. The dataset contains both numerical and categorical features, making it a good fit to test the capabilities of our implementation.</p>
<p>Load the data from Huggingface</p>
<div id="81c8b2d1" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>df_census <span class="op">=</span> pd.read_csv(</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"https://huggingface.co/datasets/scikit-learn/adult-census-income/raw/main/adult.csv"</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>df_census.head(<span class="dv">20</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<div class="table-container">
            
            <script src="https://cdn.jsdelivr.net/gh/nsarang/framedisplay@v1.2.1/framedisplay/js/framedisplay.min.js"></script>
            
        
<table class="frame-display-table caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header" style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" data-dtype="int">age</th>
<th data-quarto-table-cell-role="th" data-dtype="string">workclass</th>
<th data-quarto-table-cell-role="th" data-dtype="int">fnlwgt</th>
<th data-quarto-table-cell-role="th" data-dtype="string">education</th>
<th data-quarto-table-cell-role="th" data-dtype="int">education.num</th>
<th data-quarto-table-cell-role="th" data-dtype="string">marital.status</th>
<th data-quarto-table-cell-role="th" data-dtype="string">occupation</th>
<th data-quarto-table-cell-role="th" data-dtype="string">relationship</th>
<th data-quarto-table-cell-role="th" data-dtype="string">race</th>
<th data-quarto-table-cell-role="th" data-dtype="string">sex</th>
<th data-quarto-table-cell-role="th" data-dtype="int">capital.gain</th>
<th data-quarto-table-cell-role="th" data-dtype="int">capital.loss</th>
<th data-quarto-table-cell-role="th" data-dtype="int">hours.per.week</th>
<th data-quarto-table-cell-role="th" data-dtype="string">native.country</th>
<th data-quarto-table-cell-role="th" data-dtype="string">income</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>90</td>
<td>?</td>
<td>77053</td>
<td>HS-grad</td>
<td>9</td>
<td>Widowed</td>
<td>?</td>
<td>Not-in-family</td>
<td>White</td>
<td>Female</td>
<td>0</td>
<td>4356</td>
<td>40</td>
<td>United-States</td>
<td>&lt;=50K</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>82</td>
<td>Private</td>
<td>132870</td>
<td>HS-grad</td>
<td>9</td>
<td>Widowed</td>
<td>Exec-managerial</td>
<td>Not-in-family</td>
<td>White</td>
<td>Female</td>
<td>0</td>
<td>4356</td>
<td>18</td>
<td>United-States</td>
<td>&lt;=50K</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>66</td>
<td>?</td>
<td>186061</td>
<td>Some-college</td>
<td>10</td>
<td>Widowed</td>
<td>?</td>
<td>Unmarried</td>
<td>Black</td>
<td>Female</td>
<td>0</td>
<td>4356</td>
<td>40</td>
<td>United-States</td>
<td>&lt;=50K</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>54</td>
<td>Private</td>
<td>140359</td>
<td>7th-8th</td>
<td>4</td>
<td>Divorced</td>
<td>Machine-op-inspct</td>
<td>Unmarried</td>
<td>White</td>
<td>Female</td>
<td>0</td>
<td>3900</td>
<td>40</td>
<td>United-States</td>
<td>&lt;=50K</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>41</td>
<td>Private</td>
<td>264663</td>
<td>Some-college</td>
<td>10</td>
<td>Separated</td>
<td>Prof-specialty</td>
<td>Own-child</td>
<td>White</td>
<td>Female</td>
<td>0</td>
<td>3900</td>
<td>40</td>
<td>United-States</td>
<td>&lt;=50K</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>34</td>
<td>Private</td>
<td>216864</td>
<td>HS-grad</td>
<td>9</td>
<td>Divorced</td>
<td>Other-service</td>
<td>Unmarried</td>
<td>White</td>
<td>Female</td>
<td>0</td>
<td>3770</td>
<td>45</td>
<td>United-States</td>
<td>&lt;=50K</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>38</td>
<td>Private</td>
<td>150601</td>
<td>10th</td>
<td>6</td>
<td>Separated</td>
<td>Adm-clerical</td>
<td>Unmarried</td>
<td>White</td>
<td>Male</td>
<td>0</td>
<td>3770</td>
<td>40</td>
<td>United-States</td>
<td>&lt;=50K</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>74</td>
<td>State-gov</td>
<td>88638</td>
<td>Doctorate</td>
<td>16</td>
<td>Never-married</td>
<td>Prof-specialty</td>
<td>Other-relative</td>
<td>White</td>
<td>Female</td>
<td>0</td>
<td>3683</td>
<td>20</td>
<td>United-States</td>
<td>&gt;50K</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>68</td>
<td>Federal-gov</td>
<td>422013</td>
<td>HS-grad</td>
<td>9</td>
<td>Divorced</td>
<td>Prof-specialty</td>
<td>Not-in-family</td>
<td>White</td>
<td>Female</td>
<td>0</td>
<td>3683</td>
<td>40</td>
<td>United-States</td>
<td>&lt;=50K</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>41</td>
<td>Private</td>
<td>70037</td>
<td>Some-college</td>
<td>10</td>
<td>Never-married</td>
<td>Craft-repair</td>
<td>Unmarried</td>
<td>White</td>
<td>Male</td>
<td>0</td>
<td>3004</td>
<td>60</td>
<td>?</td>
<td>&gt;50K</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">10</th>
<td>45</td>
<td>Private</td>
<td>172274</td>
<td>Doctorate</td>
<td>16</td>
<td>Divorced</td>
<td>Prof-specialty</td>
<td>Unmarried</td>
<td>Black</td>
<td>Female</td>
<td>0</td>
<td>3004</td>
<td>35</td>
<td>United-States</td>
<td>&gt;50K</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">11</th>
<td>38</td>
<td>Self-emp-not-inc</td>
<td>164526</td>
<td>Prof-school</td>
<td>15</td>
<td>Never-married</td>
<td>Prof-specialty</td>
<td>Not-in-family</td>
<td>White</td>
<td>Male</td>
<td>0</td>
<td>2824</td>
<td>45</td>
<td>United-States</td>
<td>&gt;50K</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">12</th>
<td>52</td>
<td>Private</td>
<td>129177</td>
<td>Bachelors</td>
<td>13</td>
<td>Widowed</td>
<td>Other-service</td>
<td>Not-in-family</td>
<td>White</td>
<td>Female</td>
<td>0</td>
<td>2824</td>
<td>20</td>
<td>United-States</td>
<td>&gt;50K</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">13</th>
<td>32</td>
<td>Private</td>
<td>136204</td>
<td>Masters</td>
<td>14</td>
<td>Separated</td>
<td>Exec-managerial</td>
<td>Not-in-family</td>
<td>White</td>
<td>Male</td>
<td>0</td>
<td>2824</td>
<td>55</td>
<td>United-States</td>
<td>&gt;50K</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">14</th>
<td>51</td>
<td>?</td>
<td>172175</td>
<td>Doctorate</td>
<td>16</td>
<td>Never-married</td>
<td>?</td>
<td>Not-in-family</td>
<td>White</td>
<td>Male</td>
<td>0</td>
<td>2824</td>
<td>40</td>
<td>United-States</td>
<td>&gt;50K</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">15</th>
<td>46</td>
<td>Private</td>
<td>45363</td>
<td>Prof-school</td>
<td>15</td>
<td>Divorced</td>
<td>Prof-specialty</td>
<td>Not-in-family</td>
<td>White</td>
<td>Male</td>
<td>0</td>
<td>2824</td>
<td>40</td>
<td>United-States</td>
<td>&gt;50K</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">16</th>
<td>45</td>
<td>Private</td>
<td>172822</td>
<td>11th</td>
<td>7</td>
<td>Divorced</td>
<td>Transport-moving</td>
<td>Not-in-family</td>
<td>White</td>
<td>Male</td>
<td>0</td>
<td>2824</td>
<td>76</td>
<td>United-States</td>
<td>&gt;50K</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">17</th>
<td>57</td>
<td>Private</td>
<td>317847</td>
<td>Masters</td>
<td>14</td>
<td>Divorced</td>
<td>Exec-managerial</td>
<td>Not-in-family</td>
<td>White</td>
<td>Male</td>
<td>0</td>
<td>2824</td>
<td>50</td>
<td>United-States</td>
<td>&gt;50K</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">18</th>
<td>22</td>
<td>Private</td>
<td>119592</td>
<td>Assoc-acdm</td>
<td>12</td>
<td>Never-married</td>
<td>Handlers-cleaners</td>
<td>Not-in-family</td>
<td>Black</td>
<td>Male</td>
<td>0</td>
<td>2824</td>
<td>40</td>
<td>?</td>
<td>&gt;50K</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">19</th>
<td>34</td>
<td>Private</td>
<td>203034</td>
<td>Bachelors</td>
<td>13</td>
<td>Separated</td>
<td>Sales</td>
<td>Not-in-family</td>
<td>White</td>
<td>Male</td>
<td>0</td>
<td>2824</td>
<td>50</td>
<td>United-States</td>
<td>&gt;50K</td>
</tr>
</tbody>
</table>

    
        </div>
</div>
</div>
<div id="707a5f14" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> df_census.replace(<span class="st">"?"</span>, np.nan).drop(columns<span class="op">=</span>[<span class="st">"income"</span>])</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> (df_census[<span class="st">"income"</span>] <span class="op">==</span> <span class="st">"&gt;50K"</span>).astype(<span class="bu">int</span>).to_numpy()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Split the data into training and testing sets with stratification to preserve class distribution.</p>
<div id="c5e5e3dc" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    X, y, stratify<span class="op">=</span>y, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Fit the model with Bernoulli distribution, since this is a binary classification task.</p>
<div id="d31c4bd0" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> src.gbm <span class="im">import</span> GradientBoostedModel</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> src.distributions <span class="im">import</span> Bernoulli</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>dist_bernoulli <span class="op">=</span> Bernoulli()</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>gbm <span class="op">=</span> GradientBoostedModel(</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    learning_rate<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    n_trees<span class="op">=</span><span class="dv">50</span>,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    n_leaves<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    max_depth<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    max_bins<span class="op">=</span><span class="dv">255</span>,</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    max_categories<span class="op">=</span><span class="dv">15</span>,</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    l2_regularization<span class="op">=</span><span class="fl">0.0</span>,</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    min_weight_leaf<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    min_gain_to_split<span class="op">=</span><span class="fl">0.0</span>,</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    goss_top_rate<span class="op">=</span><span class="fl">0.3</span>,</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    goss_bottom_rate<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    goss_rescale_bottom<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    path_smoothing_strength<span class="op">=</span><span class="fl">0.25</span>,</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    seed<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    feature_fraction<span class="op">=</span><span class="fl">0.9</span>,</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    samples_fraction<span class="op">=</span><span class="fl">0.8</span>,</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    distribution<span class="op">=</span>dist_bernoulli,</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    verbose<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>gbm.fit(X_train, y_train)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"e1cf5ffeb752479eb4f710d6f2765b92","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<p>This dataset has a few categorical features. Since <code>max_categories</code> is set to 15, those with more than 15 unique values will be treated as continuous features by encoding them using target statistics.</p>
<div id="c0baeb91" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>array <span class="op">=</span> gbm.data_processor_.transform(X_test)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(array, columns<span class="op">=</span>X_test.columns)[[<span class="st">"native.country"</span>, <span class="st">"education"</span>, <span class="st">"race"</span>, <span class="st">"sex"</span>]].head(<span class="dv">10</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<div class="table-container">
            
            <script src="https://cdn.jsdelivr.net/gh/nsarang/framedisplay@v1.2.1/framedisplay/js/framedisplay.min.js"></script>
            
        
<table class="frame-display-table caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header" style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" data-dtype="float">native.country</th>
<th data-quarto-table-cell-role="th" data-dtype="float">education</th>
<th data-quarto-table-cell-role="th" data-dtype="int">race</th>
<th data-quarto-table-cell-role="th" data-dtype="int">sex</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>0.24591967894420672</td>
<td>0.4130081709599835</td>
<td>4.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>0.24591967894420672</td>
<td>0.1595181706586484</td>
<td>4.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>0.24591967894420672</td>
<td>0.4130081709599835</td>
<td>4.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>0.24591967894420672</td>
<td>0.7424649388331821</td>
<td>4.0</td>
<td>0.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>0.24591967894420672</td>
<td>0.1595181706586484</td>
<td>4.0</td>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>0.24591967894420672</td>
<td>0.1595181706586484</td>
<td>4.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td><code class="null-cell">null</code></td>
<td>0.06636229734696716</td>
<td>4.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>0.24591967894420672</td>
<td>0.4130081709599835</td>
<td>2.0</td>
<td>0.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>0.24591967894420672</td>
<td>0.05338530176077435</td>
<td>2.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>0.24591967894420672</td>
<td>0.1595181706586484</td>
<td>4.0</td>
<td>0.0</td>
</tr>
</tbody>
</table>

    
        </div>
</div>
</div>
<p>We can see that some features like “race” have been transformed into integer codes while others with more unique values have been target-statistic encoded. The reason we use integer code rather than keeping original string values is that the transformed dataset is supposed to be a homogeneous float64 numpy array. So it’s more about implementation convenience.</p>
<p>This was just an example demonstrating the capabilities of the data processor.</p>
<p>Now let’s evaluate on the test set using F1-score and ROC-AUC.</p>
<div id="5bcddf39" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> f1_score, roc_auc_score</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> src.utils <span class="im">import</span> trunc</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>test_probs <span class="op">=</span> gbm.predict(X_test)[:, <span class="dv">0</span>]</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>class_labels <span class="op">=</span> (test_probs <span class="op">&gt;=</span> <span class="fl">0.5</span>).astype(<span class="bu">int</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>f1 <span class="op">=</span> f1_score(y_test, class_labels, average<span class="op">=</span><span class="st">"binary"</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>roc_auc <span class="op">=</span> roc_auc_score(y_test, test_probs)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Test F1 Score: </span><span class="sc">{</span>trunc(f1)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Test ROC AUC Score: </span><span class="sc">{</span>trunc(roc_auc)<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Test F1 Score: 0.6942
Test ROC AUC Score: 0.9194</code></pre>
</div>
</div>
<p>Plot the confusion matrix</p>
<div id="785821dd" class="cell" data-execution_count="18">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> confusion_matrix, ConfusionMatrixDisplay</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>cm <span class="op">=</span> confusion_matrix(y_test, class_labels)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">5</span>), dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>ConfusionMatrixDisplay(cm, display_labels<span class="op">=</span>[<span class="st">"&lt;=50K"</span>, <span class="st">"&gt;50K"</span>]).plot(ax<span class="op">=</span>ax)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Confusion Matrix"</span>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-18-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Plot the ROC curve. The ROC curve summarizes the trade-off between true positive rate and false positive rate as we vary the decision threshold.</p>
<div id="f9e778f1" class="cell" data-execution_count="19">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> roc_curve, auc</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>fpr, tpr, thresholds <span class="op">=</span> roc_curve(y_test, test_probs)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>roc_auc <span class="op">=</span> auc(fpr, tpr)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">7</span>, <span class="dv">6</span>), dpi<span class="op">=</span><span class="dv">200</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>plt.plot(fpr, tpr, color<span class="op">=</span><span class="st">"blue"</span>, label<span class="op">=</span><span class="ss">f"ROC curve (area = </span><span class="sc">{</span>roc_auc<span class="sc">:.2f}</span><span class="ss">)"</span>)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>plt.plot([<span class="dv">0</span>, <span class="dv">1</span>], [<span class="dv">0</span>, <span class="dv">1</span>], color<span class="op">=</span><span class="st">"red"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>plt.xlim([<span class="fl">0.0</span>, <span class="fl">1.0</span>])</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>plt.ylim([<span class="fl">0.0</span>, <span class="fl">1.05</span>])</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"False Positive Rate"</span>)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"True Positive Rate"</span>)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"ROC Curve"</span>)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="st">"lower right"</span>)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-19-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Let’s now train and evaluate an LightGBM model with similar hyperparameters.</p>
<div id="b88aa7ea" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>pip install lightgbm <span class="op">--</span>quiet</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> lightgbm <span class="im">as</span> lgb</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>categorical_cols <span class="op">=</span> <span class="bu">list</span>(X_train.select_dtypes(include<span class="op">=</span>[<span class="st">"object"</span>, <span class="st">"category"</span>]).columns)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>X_train2 <span class="op">=</span> X_train.copy()</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>X_test2 <span class="op">=</span> X_test.copy()</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>X_train2[categorical_cols] <span class="op">=</span> X_train2[categorical_cols].astype(<span class="st">"category"</span>)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> categorical_cols:</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    X_test2[col] <span class="op">=</span> pd.Categorical(X_test2[col], categories<span class="op">=</span>X_train2[col].cat.categories)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>lgb_train <span class="op">=</span> lgb.Dataset(X_train2, y_train, categorical_feature<span class="op">=</span>categorical_cols)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>lgb_eval <span class="op">=</span> lgb.Dataset(X_test2, y_test, reference<span class="op">=</span>lgb_train, categorical_feature<span class="op">=</span>categorical_cols)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>lgbm <span class="op">=</span> lgb.LGBMClassifier(</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    objective<span class="op">=</span><span class="st">"binary"</span>,</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    learning_rate<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    n_estimators<span class="op">=</span><span class="dv">50</span>,</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    num_leaves<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    max_depth<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    min_data_in_leaf<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    reg_lambda<span class="op">=</span><span class="fl">0.0</span>,</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    data_sample_strategy<span class="op">=</span><span class="st">"goss"</span>,</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    top_rate<span class="op">=</span><span class="fl">0.3</span>,</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    other_rate<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    feature_fraction<span class="op">=</span><span class="fl">0.9</span>,</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    bagging_fraction<span class="op">=</span><span class="fl">0.8</span>,</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    seed<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    verbose<span class="op">=-</span><span class="dv">1</span>,</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>    path_smooth<span class="op">=</span><span class="fl">0.25</span>,</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>lgbm.fit(X_train2, y_train)</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>lgbm_test_probs <span class="op">=</span> lgbm.predict_proba(X_test2)[:, <span class="dv">1</span>]</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>class_labels <span class="op">=</span> (lgbm_test_probs <span class="op">&gt;=</span> <span class="fl">0.5</span>).astype(<span class="bu">int</span>)</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>f1 <span class="op">=</span> f1_score(y_test, class_labels, average<span class="op">=</span><span class="st">"binary"</span>)</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>roc_auc <span class="op">=</span> roc_auc_score(y_test, lgbm_test_probs)</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Test F1 Score: </span><span class="sc">{</span>trunc(f1)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Test ROC AUC Score: </span><span class="sc">{</span>trunc(roc_auc)<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Note: you may need to restart the kernel to use updated packages.
Test F1 Score: 0.69808
Test ROC AUC Score: 0.9208</code></pre>
</div>
</div>
<p>We can see they have similar performance. To make it complete let’s include CatBoost in the comparison as well:</p>
<div id="7063d712" class="cell" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>pip install catboost <span class="op">--</span>quiet</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> catboost <span class="im">as</span> cb</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>categorical_cols <span class="op">=</span> <span class="bu">list</span>(X_train.select_dtypes(include<span class="op">=</span>[<span class="st">"object"</span>, <span class="st">"category"</span>]).columns)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>X_train_cb <span class="op">=</span> X_train.copy()</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>X_test_cb <span class="op">=</span> X_test.copy()</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> categorical_cols:</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    X_train_cb[col] <span class="op">=</span> X_train_cb[col].replace({np.nan: <span class="va">None</span>}).astype(<span class="bu">str</span>)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    X_test_cb[col] <span class="op">=</span> X_test_cb[col].replace({np.nan: <span class="va">None</span>}).astype(<span class="bu">str</span>)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>train_pool <span class="op">=</span> cb.Pool(X_train_cb, y_train, cat_features<span class="op">=</span>categorical_cols)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>val_pool <span class="op">=</span> cb.Pool(X_test_cb, y_test, cat_features<span class="op">=</span>categorical_cols)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>catboost_model <span class="op">=</span> cb.CatBoostClassifier(</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    loss_function<span class="op">=</span><span class="st">"Logloss"</span>,</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    iterations<span class="op">=</span><span class="dv">50</span>,</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    learning_rate<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    depth<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    l2_leaf_reg<span class="op">=</span><span class="fl">0.0</span>,</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    random_seed<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    verbose<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    allow_writing_files<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>catboost_model.fit(train_pool)</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>cb_test_probs <span class="op">=</span> catboost_model.predict_proba(val_pool)[:, <span class="dv">1</span>]</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>class_labels <span class="op">=</span> (cb_test_probs <span class="op">&gt;=</span> <span class="fl">0.5</span>).astype(<span class="bu">int</span>)</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>f1 <span class="op">=</span> f1_score(y_test, class_labels, average<span class="op">=</span><span class="st">"binary"</span>)</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>roc_auc <span class="op">=</span> roc_auc_score(y_test, cb_test_probs)</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Test F1 Score: </span><span class="sc">{</span>trunc(f1)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Test ROC AUC Score: </span><span class="sc">{</span>trunc(roc_auc)<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Note: you may need to restart the kernel to use updated packages.
Test F1 Score: 0.6861
Test ROC AUC Score: 0.9162</code></pre>
</div>
</div>
<p>The performance across all three implementations is comparable, demonstrating that our implementation captures the essential components of modern GBT algorithms while remaining simple and extensible.</p>
</section>
<section id="california-housing-price" class="level2" data-number="5.2">
<h2 data-number="5.2" data-anchor-id="california-housing-price"><span class="header-section-number">5.2</span> California Housing Price</h2>
<p>This dataset contains information about house prices in California, including features like median income, average house age, average number of rooms, etc. The target variable is the median house value for each district. All features are numerical.</p>
<div id="4a129a4a" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.datasets <span class="im">import</span> fetch_california_housing</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>X, y <span class="op">=</span> fetch_california_housing(return_X_y<span class="op">=</span><span class="va">True</span>, as_frame<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>X.head(<span class="dv">20</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<div class="table-container">
            
            <script src="https://cdn.jsdelivr.net/gh/nsarang/framedisplay@v1.2.1/framedisplay/js/framedisplay.min.js"></script>
            
        
<table class="frame-display-table caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header" style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" data-dtype="float">MedInc</th>
<th data-quarto-table-cell-role="th" data-dtype="int">HouseAge</th>
<th data-quarto-table-cell-role="th" data-dtype="float">AveRooms</th>
<th data-quarto-table-cell-role="th" data-dtype="float">AveBedrms</th>
<th data-quarto-table-cell-role="th" data-dtype="int">Population</th>
<th data-quarto-table-cell-role="th" data-dtype="float">AveOccup</th>
<th data-quarto-table-cell-role="th" data-dtype="float">Latitude</th>
<th data-quarto-table-cell-role="th" data-dtype="float">Longitude</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>8.3252</td>
<td>41.0</td>
<td>6.984126984126984</td>
<td>1.0238095238095237</td>
<td>322.0</td>
<td>2.5555555555555554</td>
<td>37.88</td>
<td>-122.23</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>8.3014</td>
<td>21.0</td>
<td>6.238137082601054</td>
<td>0.9718804920913884</td>
<td>2401.0</td>
<td>2.109841827768014</td>
<td>37.86</td>
<td>-122.22</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>7.2574</td>
<td>52.0</td>
<td>8.288135593220339</td>
<td>1.073446327683616</td>
<td>496.0</td>
<td>2.8022598870056497</td>
<td>37.85</td>
<td>-122.24</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>5.6431</td>
<td>52.0</td>
<td>5.8173515981735155</td>
<td>1.0730593607305936</td>
<td>558.0</td>
<td>2.547945205479452</td>
<td>37.85</td>
<td>-122.25</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>3.8462</td>
<td>52.0</td>
<td>6.281853281853282</td>
<td>1.0810810810810811</td>
<td>565.0</td>
<td>2.1814671814671813</td>
<td>37.85</td>
<td>-122.25</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>4.0368</td>
<td>52.0</td>
<td>4.761658031088083</td>
<td>1.1036269430051813</td>
<td>413.0</td>
<td>2.139896373056995</td>
<td>37.85</td>
<td>-122.25</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>3.6591</td>
<td>52.0</td>
<td>4.9319066147859925</td>
<td>0.9513618677042801</td>
<td>1094.0</td>
<td>2.1284046692607004</td>
<td>37.84</td>
<td>-122.25</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>3.12</td>
<td>52.0</td>
<td>4.797527047913447</td>
<td>1.061823802163833</td>
<td>1157.0</td>
<td>1.7882534775888717</td>
<td>37.84</td>
<td>-122.25</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>2.0804</td>
<td>42.0</td>
<td>4.294117647058823</td>
<td>1.1176470588235294</td>
<td>1206.0</td>
<td>2.026890756302521</td>
<td>37.84</td>
<td>-122.26</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>3.6912</td>
<td>52.0</td>
<td>4.970588235294118</td>
<td>0.9901960784313726</td>
<td>1551.0</td>
<td>2.172268907563025</td>
<td>37.84</td>
<td>-122.25</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">10</th>
<td>3.2031</td>
<td>52.0</td>
<td>5.477611940298507</td>
<td>1.0796019900497513</td>
<td>910.0</td>
<td>2.263681592039801</td>
<td>37.85</td>
<td>-122.26</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">11</th>
<td>3.2705</td>
<td>52.0</td>
<td>4.772479564032698</td>
<td>1.0245231607629428</td>
<td>1504.0</td>
<td>2.0490463215258856</td>
<td>37.85</td>
<td>-122.26</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">12</th>
<td>3.075</td>
<td>52.0</td>
<td>5.322649572649572</td>
<td>1.0128205128205128</td>
<td>1098.0</td>
<td>2.3461538461538463</td>
<td>37.85</td>
<td>-122.26</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">13</th>
<td>2.6736</td>
<td>52.0</td>
<td>4.0</td>
<td>1.0977011494252873</td>
<td>345.0</td>
<td>1.9827586206896552</td>
<td>37.84</td>
<td>-122.26</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">14</th>
<td>1.9167</td>
<td>52.0</td>
<td>4.262903225806451</td>
<td>1.0096774193548388</td>
<td>1212.0</td>
<td>1.9548387096774194</td>
<td>37.85</td>
<td>-122.26</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">15</th>
<td>2.125</td>
<td>50.0</td>
<td>4.242424242424242</td>
<td>1.071969696969697</td>
<td>697.0</td>
<td>2.640151515151515</td>
<td>37.85</td>
<td>-122.26</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">16</th>
<td>2.775</td>
<td>52.0</td>
<td>5.9395770392749245</td>
<td>1.0483383685800605</td>
<td>793.0</td>
<td>2.395770392749245</td>
<td>37.85</td>
<td>-122.27</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">17</th>
<td>2.1202</td>
<td>52.0</td>
<td>4.052805280528053</td>
<td>0.966996699669967</td>
<td>648.0</td>
<td>2.1386138613861387</td>
<td>37.85</td>
<td>-122.27</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">18</th>
<td>1.9911</td>
<td>50.0</td>
<td>5.343675417661098</td>
<td>1.0859188544152745</td>
<td>990.0</td>
<td>2.3627684964200477</td>
<td>37.84</td>
<td>-122.26</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">19</th>
<td>2.6033</td>
<td>52.0</td>
<td>5.465454545454546</td>
<td>1.0836363636363637</td>
<td>690.0</td>
<td>2.5090909090909093</td>
<td>37.84</td>
<td>-122.27</td>
</tr>
</tbody>
</table>

    
        </div>
</div>
</div>
<p>Split the data into training and testing sets, with stratification to ensure the target distribution is (somewhat) preserved in both sets.</p>
<div id="1486652a" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    X,</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    y,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    stratify<span class="op">=</span>np.digitize(y, bins<span class="op">=</span>np.histogram_bin_edges(y, bins<span class="op">=</span><span class="dv">10</span>)),</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    test_size<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Fit the model to the training data using Gaussian distribution. By using <code>learn_variance=True</code>, the model will also learn to predict the variance of the target for heteroscedastic uncertainty estimation.</p>
<div id="0703e94b" class="cell" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> src.gbm <span class="im">import</span> GradientBoostedModel</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> src.distributions <span class="im">import</span> Gaussian</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>dist_normal <span class="op">=</span> Gaussian(learn_variance<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>gbm <span class="op">=</span> GradientBoostedModel(</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    learning_rate<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    n_trees<span class="op">=</span><span class="dv">50</span>,</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    n_leaves<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    max_depth<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    max_bins<span class="op">=</span><span class="dv">255</span>,</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    l2_regularization<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    min_weight_leaf<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    min_gain_to_split<span class="op">=</span><span class="fl">0.0</span>,</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    goss_top_rate<span class="op">=</span><span class="fl">0.3</span>,</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    goss_bottom_rate<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    seed<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    feature_fraction<span class="op">=</span><span class="fl">0.9</span>,</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    samples_fraction<span class="op">=</span><span class="fl">0.8</span>,</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    distribution<span class="op">=</span>dist_normal,</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    verbose<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>gbm.fit(X_train, y_train)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"31567f9dc493456eb561fba7a26c6a29","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<div id="c2b4fd19" class="cell" data-execution_count="25">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Shape (n_samples, 2), having (mean, stdev) for each sample</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>test_predictions <span class="op">=</span> gbm.predict(X_test)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>squared_errors <span class="op">=</span> (test_predictions[:, <span class="dv">0</span>] <span class="op">-</span> y_test.values) <span class="op">**</span> <span class="dv">2</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>test_rmse <span class="op">=</span> np.sqrt(np.mean(squared_errors))</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Test RMSE: </span><span class="sc">{</span>trunc(test_rmse)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>test_pearson <span class="op">=</span> np.corrcoef(test_predictions[:, <span class="dv">0</span>], y_test.values)[<span class="dv">0</span>, <span class="dv">1</span>]</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Test Pearson Correlation: </span><span class="sc">{</span>trunc(test_pearson)<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Test RMSE: 0.4914
Test Pearson Correlation: 0.9087</code></pre>
</div>
</div>
<p>Plot the calibration curve to visualize how well the predictions align with the true values across different ranges. Deviations from the line indicate regions where the model tends to under- or over-predict.</p>
<div id="900fd2ac" class="cell" data-execution_count="26">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">7</span>, <span class="dv">6</span>), dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calibration plot</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>sns.scatterplot(x<span class="op">=</span>y_test, y<span class="op">=</span>test_predictions[:, <span class="dv">0</span>], alpha<span class="op">=</span><span class="fl">0.9</span>, ax<span class="op">=</span>ax)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"True Values"</span>)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Predicted Values"</span>)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Set equal limits for x and y axes</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>min_val <span class="op">=</span> <span class="bu">min</span>(y_test.<span class="bu">min</span>(), test_predictions[:, <span class="dv">0</span>].<span class="bu">min</span>())</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>max_val <span class="op">=</span> <span class="bu">max</span>(y_test.<span class="bu">max</span>(), test_predictions[:, <span class="dv">0</span>].<span class="bu">max</span>())</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(min_val, max_val)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(min_val, max_val)</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>ax.plot([min_val, max_val], [min_val, max_val], color<span class="op">=</span><span class="st">"red"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-26-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="07aeb1f6" class="cell" data-execution_count="27">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>mu, sigma <span class="op">=</span> test_predictions.T</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>cv <span class="op">=</span> sigma <span class="op">/</span> mu</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>), dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co"># mu-cv plot</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>sns.scatterplot(x<span class="op">=</span>mu, y<span class="op">=</span>cv, alpha<span class="op">=</span><span class="fl">0.5</span>, ax<span class="op">=</span>ax)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Predicted Mean (μ)"</span>)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Coefficient of Variation (σ/μ)"</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-27-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="final-thoughts" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Final thoughts</h1>
<p>I hope you found this implementation and explanation useful. I encourage you to try it out and experiment with different loss functions, and perhaps even extend it further. I had many ideas that I didn’t have time to implement such as dynamic learning rates, gradient-based binning, bagging, monotonic constraints, natural gradients, and different gain formulations. There are also engineering opportunities like early stopping and optimized histogram construction, to name a few. Maybe I’ll make another post about those in the future.</p>
<p>Thank you for reading this far. Feel free to ask any questions or provide feedback!</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a></div></div></section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{sarang2025,
  author = {Sarang, Nima},
  title = {Implementing {Gradient} {Boosted} {Trees} from {Scratch} -
    {LightGBM,} {XGBoost,} {CatBoost}},
  date = {2025-12-14},
  url = {https://www.nimasarang.com/blog/2025-12-14-gbt-algorithms/},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-sarang2025" class="csl-entry quarto-appendix-citeas" role="listitem">
<div class="">Nima Sarang. Implementing Gradient Boosted
Trees from Scratch - LightGBM, XGBoost, CatBoost, 2025. Available: <a href="https://www.nimasarang.com/blog/2025-12-14-gbt-algorithms/">https://www.nimasarang.com/blog/2025-12-14-gbt-algorithms/</a>.</div>
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("^(?:http:|https:)\/\/(?:www\.)?(nimasarang\.com)\/.*$");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark">
<script>
  function loadGiscus() {
    // Function to get the theme based on body class
    const getTheme = () => {
      let baseTheme = document.getElementById('giscus-base-theme').value;
      let altTheme = document.getElementById('giscus-alt-theme').value;
      if (authorPrefersDark) {
          [baseTheme, altTheme] = [altTheme, baseTheme];
      }
      return document.body.classList.contains('quarto-dark') ? altTheme : baseTheme;
    };
    const script = document.createElement("script");
    script.src = "https://giscus.app/client.js";
    script.async = true;
    script.dataset.repo = "nsarang/nsarang.github.io";
    script.dataset.repoId = "R_kgDOMZYgPg";
    script.dataset.category = "Announcements";
    script.dataset.categoryId = "DIC_kwDOMZYgPs4ChVIN";
    script.dataset.mapping = "pathname";
    script.dataset.reactionsEnabled = "1";
    script.dataset.emitMetadata = "0";
    script.dataset.inputPosition = "top";
    script.dataset.theme = getTheme();
    script.dataset.lang = "en";
    script.crossOrigin = "anonymous";
    // Append the script to the desired div instead of at the end of the body
    document.getElementById("quarto-content").appendChild(script);
  }
  loadGiscus();
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Copyright 2025, Nima Sarang</p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>
<script>
async function loadBodyWhenReady() {
    while (!document.body.classList.contains('quarto-light') && !document.body.classList.contains('quarto-dark')) {
        await new Promise(resolve => setTimeout(resolve, 50));
    }
    setTimeout(() => {
        document.body.style.visibility = "visible";
    }, 50); // Adjust the delay to allow for the dark mode to be loaded
}
loadBodyWhenReady();
</script>
<script src="../../_assets/docfuse/render.js"></script>




</body></html>